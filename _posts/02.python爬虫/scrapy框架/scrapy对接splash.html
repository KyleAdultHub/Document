---
title: Scrapy对接splash
date: "2017-04-18 23:00:00"
categories:
- python爬虫
- scrapy框架
tags:
- 爬虫
- scrapy
toc: true
typora-root-url: ..\..\..
---

<html>
<body>
<div>
<span><div><div><font style="font-size: 14pt;"><span style="color: rgb(50, 135, 18); font-size: 14pt; font-weight: bold; background-color: rgb(255, 250, 165);-evernote-highlight:true;">Scrapy 对接 Splash</span></font></div><ul><li><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">环境准备</span></font></div></li><ul><li><div><span style="font-size: 9pt;">首先在这之前请确保已经正确安装好了Splash并正常运行，同时安装好了ScrapySplash库</span></div></li></ul><li><div><b><font style="font-size: 12pt;">Scrapy-Splash文档</font></b></div></li><ul><li><div><span style="font-size: 9pt;">https://github.com/scrapy-plugins/scrapy-splash</span></div></li></ul></ul><ul><li><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">Scrapy-splash的配置</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">新建项目和spider</span></font></div></li><ul><li><div><span style="font-size: 9pt;">scrapy startproject scrapysplashtest     新建项目</span></div></li><li><div><span style="font-size: 9pt;">scrapy genspider taobao</span> <a href="http://www.taobao.com/" style="font-size: 9pt;">www.taobao.com</a><span style="font-size: 9pt;">     新建spider</span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">修改setting.py文件, 添加splash配置</span></font></div></li><ul><li><div><span style="font-size: 9pt;">SPLASH_URL = 'http://localhost:8050'         添加splash服务的地址</span></div></li><li><div><span style="font-size: 9pt;">DUPEFILTER_CLASS = 'scrapy_splash.SplashAwareDupeFilter'       配置去重类</span></div></li><li><div><span style="font-size: 9pt;">HTTPCACHE_STORAGE = 'scrapy_splash.SplashAwareFSCacheStorage'     还需要配置一个Cache存储HTTPCACHE_STORAGE</span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">添加splash中间件</span></font></div></li><ul><li><div><span style="font-size: 9pt;">DOWNLOADER_MIDDLEWARES = {</span></div></li><ul><li><div><span style="font-size: 9pt;">'scrapy_splash.SplashCookiesMiddleware': 723,</span></div></li><li><div><span style="font-size: 9pt;">'scrapy_splash.SplashMiddleware': 725,</span></div></li><li><div><span style="font-size: 9pt;">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware': 810,</span></div></li></ul><li><div><span style="font-size: 9pt;">}</span></div></li><li><div><span style="font-size: 9pt;">SPIDER_MIDDLEWARES = {</span></div></li><ul><li><div><span style="font-size: 9pt;">'scrapy_splash.SplashDeduplicateArgsMiddleware': 100,</span></div></li></ul><li><div><span style="font-size: 9pt;">}</span></div></li></ul></ul><li><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">SplashRequest请求的使用</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">使用splash请求的说明</span></font></div></li><ul><li><div><span style="font-size: 9pt;">配置完成之后我们就可以利用Splash来抓取页面了，例如我们可以直接生成一个SplashRequest对象并传递相应的参数，Scrapy会将此请求转发给Splash</span></div></li><li><div><span style="font-size: 9pt;">Splash对页面进行渲染加载，然后再将渲染结果传递回来，此时Response的内容就是渲染完成的页面结果了，最后交给Spider解析即可。</span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">使用请求的方法</span></font></div></li><ul><li><div><span style="font-size: 9pt;">第一种方法</span></div></li><ul><li><div><span style="font-size: 9pt;">通过SplashRequest发送请求</span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy对接splash_files/Image.png" type="image/png" data-filename="Image.png" style="font-weight: bold;" width="471"/></span></div></li></ul><li><div><span style="font-size: 9pt;">第二种方法</span></div></li><ul><li><div><span style="font-size: 9pt;">scrapy.Request对象发送请求给splash服务器，只需将配置属性给meta参数即可</span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy对接splash_files/Image [1].png" type="image/png" data-filename="Image.png" width="520"/></span></div></li></ul></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">通过lua源码控制splash服务的示例</span></font></div></li><ul><li><div><span style="font-size: 9pt;">我们把Lua脚本定义成长字符串，通过SplashRequest的args来传递参数，同时接口修改为execute，另外args参数里还有一个lua_source字段用于指定Lua脚本内容，这样我们就成功构造了一个SplashRequest，对接Splash的工作就完成了。</span></div></li></ul></ul></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                from scrapy import Spider</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                from urllib.parse import quote</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                from scrapysplashtest.items import ProductItem</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                from scrapy_splash import SplashRequest</font></span></div><div><br style="font-family: Monaco; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                script = &quot;&quot;&quot;</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                function main(splash, args)</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                splash.images_enabled = false</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                assert(splash:go(args.url))</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                assert(splash:wait(args.wait))</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                js = string.format(&quot;document.querySelector('#mainsrp-pager div.form &gt; input').value=%d;document.querySelector('#mainsrp-pager div.form &gt; span.btn.J_Submit').click()&quot;, args.page)</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                splash:evaljs(js)</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                assert(splash:wait(args.wait))</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                return splash:html()</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                end</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                &quot;&quot;&quot;</font></span></div><div><br style="font-family: Monaco; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                class TaobaoSpider(Spider):</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                name = 'taobao'</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                allowed_domains = ['www.taobao.com']</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                base_url = 'https://s.taobao.com/search?q='</font></span></div><div><br style="font-family: Monaco; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                def start_requests(self):</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                for keyword in self.settings.get('KEYWORDS'):</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                for page in range(1, self.settings.get('MAX_PAGE') + 1):</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                url = self.base_url + quote(keyword)</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                yield SplashRequest(</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                        url,</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                        callback=self.parse,</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                        endpoint='execute',</font></span></div><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 9pt;">                                        args={'lua_source': script, 'page': page, 'wait': 7})</font></span></div></div><ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">使用scrapy-splash比使用selenium的优点</span></font></div></li><ul><li><div><span style="font-size: 9pt;">由于Splash和Scrapy都支持异步处理，我们可以看到同时会有多个抓取成功的结果，而Selenium的对接过程中每个页面渲染下载过程是在Downloader Middleware里面完成的，所以整个过程是堵塞式的，Scrapy会等待这个过程完成后再继续处理和调度其他请求，影响了爬取效率。</span></div></li><li><div><span style="font-size: 9pt;">使用Splash，是在中间件中将请求和渲染等工作交给了splash服务器, 各请求之间是异步的，因此使用Splash爬取效率上比Selenium高出很多。</span></div></li><li><div><span style="font-size: 9pt;">因此，在Scrapy中要处理JavaScript渲染的页面建议使用Splash，这样不会破坏Scrapy中的异步处理过程，会大大提高爬取效率，而且Splash的安装和配置比较简单，通过API调用的方式也实现了模块分离，大规模爬取时部署起来也更加方便。</span></div></li></ul></ul><div><br/></div></div><div><br/></div></span>
</div></body></html>