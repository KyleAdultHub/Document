---
title: ADSL代理服务器搭建&代理池
date: "2017-05-10 23:00:00"
categories:
- python爬虫
- 爬虫常见反反爬
tags:
- 爬虫
- 反反爬
toc: true
typora-root-url: ..\..\..
---

<html>
<body>
<div>
<span><div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">ADSL的介绍和使用</span></span></div><ul><li><div><span style="font-size: 12pt; font-weight: bold;">什么是ADSL</span></div></li><ul><li><div><span style="font-size: 9pt;">ADSL全称叫做Asymmetric Digital Subscriber Line，非对称数字用户环路，因为它的上行和下行带宽不对称。</span></div></li><li><div><span style="font-size: 9pt;">它采用频分复用技术把普通的电话线分成了电话、上行和下行三个相对独立的信道，从而避免了相互之间的干扰。</span></div></li><li><div><span style="font-size: 9pt;">有种主机叫做动态拨号VPS主机，这种主机在连接上网的时候是需要拨号的，只有拨号成功后才可以上网；</span></div></li><li><div><span style="font-size: 9pt;">每拨一次号，主机就会获取一个新的IP，也就是它的IP并不是固定的，而且IP量特别大，几乎不会拨到相同的IP，如果我们用它来搭建代理，既能保证高度可用，又可以自由控制拨号切换。</span></div></li></ul><li><div><span style="font-size: 12pt; font-weight: bold;">连接ADSL服务器(推荐云代理)</span></div></li><ul><li><div><span style="font-size: 9pt;">ssh root@153.36.65.214 -p 20063</span></div></li></ul><li><div><span style="font-size: 12pt; font-weight: bold;">ADSL服务器的使用</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">拨号初始化</span></span></div></li><ul><li><div><span style="font-size: 9pt;">进入之后，可以发现有一个可用的脚本文件，叫做ppp.sh，这是拨号初始化的脚本，运行它会让我们输入拨号的用户名和密码，然后它就会开始各种拨号配置，一次配置成功；</span></div></li><li><div><span style="font-size: 9pt;">后面的拨号就不需要重复输入用户名和密码了；</span></div></li><li><div><span style="font-size: 9pt;">都提示成功之后就可以进行拨号了。</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">拨号命令</span></span></div></li><ul><li><div><span style="font-size: 9pt;">adsl-start</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">停止拨号</span></span></div></li><ul><li><div><span style="font-size: 9pt;">adsl-stop</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">断线重播</span></span></div></li><ul><li><div><span style="font-size: 9pt;">先执行adsl-stop再执行adsl-start</span></div></li></ul></ul><li><div><span style="font-size: 12pt; font-weight: bold;">将ADSL服务器设置为代理服务器</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">使用的工具</span></span></div></li><ul><li><div><span style="font-size: 9pt;">在Linux下搭建HTTP代理服务器，推荐TinyProxy和Squid，配置都非常简单，在这里我们以TinyProxy为例来讲解一下怎样搭建代理服务器。</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">配置步骤</span></span></div></li><ul><li><div><span style="font-size: 9pt;">安装TinyProxy</span></div></li><ul><li><div><span style="font-size: 9pt;">yum install -y epel-release</span></div></li><li><div><span style="font-size: 9pt;">yum update -y</span></div></li><li><div><span style="font-size: 9pt;">yum install -y tinyproxy</span></div></li></ul><li><div><span style="font-size: 9pt;">配置TinyProxy</span></div></li><ul><li><div><span style="font-size: 9pt;">vi /etc/tinyproxy/tinyproxy.conf</span></div></li><li><div><span style="font-size: 9pt;">修改如下行</span></div></li><li><div><span style="font-size: 9pt;">Port 8888      代理的端口</span></div></li><li><div><span style="font-size: 9pt;">Allow 127.0.0.1     允许连接的主机，默认只允许本机连接，可以注释掉，允许所有主机连接</span></div></li></ul><li><div><span style="font-size: 9pt;">重启tinyproxy</span></div></li><ul><li><div><span style="font-size: 9pt;">service tinyproxy start</span></div></li></ul><li><div><span style="font-size: 9pt;">测试(在其他主机上操作)</span></div></li><ul><li><div><span style="font-size: 9pt;">curl -x 112.84.118.216:8888</span> <a href="http://httpbin.org/get" style="font-size: 9pt;">httpbin.org/get</a></div></li><ul><li><div><span style="font-size: 9pt;">查看请求结果是不是设置的代理ip</span></div></li></ul></ul></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">动态获取IP</span></span></div><ul><li><div><span style="font-size: 12pt; font-weight: bold;">怎么动态获取ip</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">DDNS动态域名解析</span></span></div></li><ul><li><div><span style="font-size: 9pt;">我们需要使用一个域名来解析，也就是虽然IP是变的，但域名解析的地址可以随着IP的变化而变化。</span></div></li><li><div><span style="font-size: 9pt;">它的原理其实是拨号主机向固定的服务器发出请求，服务器获取客户端的IP，然后再将域名解析到这个IP上就可以了。</span></div></li><li><div><span style="font-size: 9pt;">国内比较有名的服务就是花生壳了，也提供了免费版的动态域名解析，另外DNSPOD也提供了解析接口来动态修改域名解析设置，DNSPOD，但是这样的方式都有一个通病，那就是慢！</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">自己配置ADSL代理池</span></span></div></li><ul><li><div><span style="font-size: 9pt;">所以根据花生壳的原理，可以完全自己实现一下动态获取IP的方法。</span></div></li><li><div><span style="font-size: 9pt;">要实现这个需要两台主机，一台主机就是这台动态拨号VPS主机，另一台是具有固定公网IP的主机。</span></div></li><li><div><span style="font-size: 9pt;">动态VPS主机拨号成功之后就请求远程的固定主机，远程主机获取动态VPS主机的IP，就可以得到这个代理，将代理保存下来，这样拨号主机每拨号一次，远程主机就会及时得到拨号主机的IP，如果有多台拨号VPS，也统一发送到远程主机，这样我们只需要从远程主机取下代理就好了，保准是实时可用，稳定高效的。</span></div></li></ul></ul><li><div><span style="font-size: 12pt; font-weight: bold;">ADSL代理池远程主机和ADSL拨号服务器的功能划分</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">远程主机</span></span></div></li><ul><li><div><span style="font-size: 9pt;">监听主机请求，获取动态VPS主机IP</span></div></li><li><div><span style="font-size: 9pt;">将VPS主机IP记录下来存入数据库，支持多个客户端</span></div></li><li><div><span style="font-size: 9pt;">检测当前接收到的IP可用情况，如果不可用则删除</span></div></li><li><div><span style="font-size: 9pt;">提供API接口，通过API接口可获取当前可用代理IP</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">ADSL拨号服务器</span></span></div></li><ul><li><div><span style="font-size: 9pt;">定时执行拨号脚本换IP</span></div></li><li><div><span style="font-size: 9pt;">换IP后立即请求远程主机</span></div></li><li><div><span style="font-size: 9pt;">拨号后检测是否拨号成功，如果失败立即重新拨号</span></div></li></ul></ul><li><div><span style="font-size: 12pt; font-weight: bold;">远程主机实现</span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold;">存储模块</span></div></li><ul><li><div><span style="font-size: 9pt;">功能设计</span></div></li><ul><li><div><span style="font-size: 9pt;">远程主机作为一台服务器，动态拨号VPS会定时请求远程主机，远程主机接收到请求后将IP记录下来存入数据库。</span></div></li><li><div><span style="font-size: 9pt;">因为IP是一直在变化的，IP更新了之后，原来的IP就不能用了，所以对于一个主机来说我们可能需要多次更新一条数据。</span></div></li><li><div><span style="font-size: 9pt;">另外我们不能仅限于维护一台拨号VPS主机，当然是需要支持多台维护的。在这里我们直接选用Key-Value形式的非关系型数据库存储更加方便，所以在此选用Redis数据库。</span></div></li><li><div><span style="font-size: 9pt;">使用redis的Hash类型存储方式，Key就是拨号主机的名称，可以自己指定，Value就是代理的值。</span></div></li></ul></ul><li><div><span style="font-size: 9pt; font-weight: bold;">接口模块</span></div></li><ul><li><div><span style="font-size: 9pt;">功能设计</span></div></li><ul><li><div><span style="font-size: 9pt;">使用Tornado来实现</span></div></li><li><div><span style="font-size: 9pt;">实现random随机获取一个可用的动态代理功能</span></div></li><li><div><span style="font-size: 9pt;">实现count获取代理池中的代理个数</span></div></li></ul></ul></ul><li><div><span style="font-size: 12pt; font-weight: bold;">ADSL拨号服务器实现</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">拨号模块</span></span></div></li><ul><li><div><span style="font-size: 9pt;">功能设计</span></div></li><ul><li><div><span style="font-size: 9pt;">定时拨号，每隔一段时间拨号一次，更新ip</span></div></li><li><div><span style="font-size: 9pt;">更新前先清除远程主机数据库中的当前ip</span></div></li><li><div><span style="font-size: 9pt;">更新后请求远程主机，将新的ip更新到redis散列里</span></div></li></ul></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">示例代码</span></span></div><ul><li><div><a href="/e_img/ADSL代理服务器搭建和代理池_files/AdslProxy.zip"><img src="/e_img/ADSL代理服务器搭建和代理池_files/e8ca02f11446649b41c2acb45e64c359.png" alt="AdslProxy.zip"></a></div></li></ul><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div><div><br/></div></span>
</div></body></html>