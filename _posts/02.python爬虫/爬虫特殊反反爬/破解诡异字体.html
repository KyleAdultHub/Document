---
title: 破解诡异字体
date: "2017-05-22 23:00:00"
categories:
- python爬虫
- 爬虫特殊反反爬
tags:
- 爬虫
- 反反爬
toc: true
typora-root-url: ..\..\..
---

<html>
<body>
<div>
<span><div><br/></div><div style="box-sizing: border-box; font-size: 10px; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><div style="box-sizing: inherit; background-color: rgb(255, 255, 255); font-size: 16px;"><div style="box-sizing: inherit; background-color: rgb(255, 255, 255);"><div style="box-sizing: inherit;"><div style="box-sizing: inherit; word-wrap: break-word;"><div style="box-sizing: inherit;"><div style="box-sizing: inherit;"><div style="box-sizing: inherit; margin-right: 7.6923%; margin-left: 7.6923%; width: 100%;"><h1 style="box-sizing: inherit; clear: both; margin: 0px 0px 0.2em; text-rendering: optimizelegibility; font-size: 1.75rem;"><span style="font-size: 16px;"><span style="box-sizing: inherit;"><span style="font-size: 1.75rem; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Montserrat, &quot;Helvetica Neue&quot;, sans-serif; font-weight: 700; line-height: 1.25;">爬虫与诡异的字体-反爬与反反爬的奇技淫巧</span></span></span></h1></div><div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="box-sizing: inherit; margin-right: 7.6923%; margin-left: 7.6923%; border-color: rgb(209, 209, 209); width: 100%;"><span style="font-size: 16px; color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75; background-color: rgb(255, 250, 165);-evernote-highlight:true;">从今天这篇文章开始，主要给大家过一些小众的反爬策略以及其中的利弊，所以一般来说都会有一个特定的示例，比如今天的反爬策略就来自反爬界大神之一的去哪儿（当然也是爬虫界的）手机版。</span></span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">我们先来用chrome的手机模式开一下去哪儿的机票:</span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;"><img height="25" style="box-sizing:inherit;border:0px;height:auto;max-width:100%;vertical-align:middle;display:block;" width="840"></img><img src="/e_img/破解诡异字体_files/20170826150342_21359.png" type="image/png" data-filename="20170826150342_21359.png" height="528" style="box-sizing:inherit;border:0px;height:auto;max-width:100%;vertical-align:middle;display:block;" width="300"/></span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">看着叫一个干净整洁，完全没毛病。但是！当我们掀开被子看源码的时候 震惊了：</span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;"><img src="/e_img/破解诡异字体_files/20170826151158_22856.png" type="image/png" data-filename="20170826151158_22856.png" height="300" style="box-sizing:inherit;border:0px;height:auto;max-width:100%;vertical-align:middle;display:block;" width="600"/></span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="box-sizing: inherit; font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">不知道大家能不能看清图，我码字注解一下，显示的价格是560，而源码中的价格则是540！</span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">我们这篇文章就来看看去哪儿手机版是怎么做到的（当然偷偷剧透下，下篇文章咱们主角还是去哪儿）</span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">其实同学们只要智商在线，看到标题就知道，这是用字体实现，我们看右侧的css面板也可以看到，这个dom元素的字体是单独设置的。也就是去哪儿通过修改字体，让4显示成了6。</span></div><h2><span style="font-size: 24px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;color:#333333;color:inherit;margin-bottom:1.21739em;margin-top:2.43478em;font-weight:900;background-color:#FFFFFF;} &quot;; line-height: 1.21739;">1.为什么字体可以反爬</span></h2><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">感觉从这篇文章开始这个套路快进行不下去了。为什么字体可以反爬？ 首先这个迷惑性太大，很多马虎的工程师以为可以了，直接就爬下来，当然就是被老板骂的体无完肤了，对反反爬工程师的精神可以造成1万点伤害。同时呢，去哪儿这个字体是动态生成的字体，也就是说你也不知道下一次刷出来的4到底是几显示出来的。这个道行就比较高了。</span></div><h2><span style="font-size: 24px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;color:#333333;color:inherit;margin-bottom:1.21739em;margin-top:2.43478em;font-weight:900;background-color:#FFFFFF;} &quot;; line-height: 1.21739;">2.怎么做好字体反爬？</span></h2><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">这种反爬策略用在数字上确实天衣无缝，非常优雅。唯一值得提的就是一点，如何动态生成字体和页面来做好对应关系。其实这是一个工程性的问题，大部分编程语言都含有生成字体的库，如果对网站整体性能比较自信的话，完全可以每次请求都动态生成，当然这样确实会比较慢，比较推荐是通过定时任务，去更新一个字体池。每次有请求过来，从字体池中随机拿一个字体，换一个随机的名字（可以通过url rewrite来实现），并和现在的数字做一次映射，调整页面显示后整体输出，就可以在尽量不影响性能的情况下搞死反反爬。</span></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">当然使用字体也是有局限的，其中最大的问题莫过于@font-face的兼容性问题，所以去哪儿只在移动端采用这个反爬策略，可能也有兼容性的考虑吧，相比之下，去哪儿的pc端的反爬写法则丑陋很多。</span></div><h2><span style="font-size: 24px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;color:#333333;color:inherit;margin-bottom:1.21739em;margin-top:2.43478em;font-weight:900;background-color:#FFFFFF;} &quot;; line-height: 1.21739;">3.遇到字体反爬怎么办？</span></h2><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: -apple-system, &quot;font-size:medium;color:#333333;background-color:#FFFFFF;} &quot;; line-height: 1.75;">好了，万一我就是要爬去哪儿机票了怎么办呢？其实字体反爬处理也并不复杂，就像前面说到的，大部分语言都有字体处理类库，而这种情况大概率来讲只有10个数字的字体，我们将字体解析后只要能找到对应关系，就简单了。这里如果是Java工程师的话，推荐用Apache.Fontbox，贴一段解析的代码，注意这段代码不保证现在可用，仅做参考：</span></div><div style="box-sizing: inherit;"><div style="white-space: pre-wrap; font-size: 1rem; border: 1px solid rgb(209, 209, 209); margin: 0px 0px 1.75em; max-width: 100%; overflow: auto; padding: 1.75em; word-wrap: break-word; box-sizing: inherit; border-radius: 4px; word-break: break-all; background-color: rgb(245, 245, 245);"><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">int[] digits = null;</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">BASE64Decoder decoder = new BASE64Decoder();</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">TTFParser parser = new TTFParser();</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">try {</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">byte[] bytes = decoder.decodeBuffer(fontBase64);</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">InputStream inputStream = new ByteArrayInputStream(bytes);</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">TrueTypeFont ttf = parser.parse(inputStream);</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">if(ttf != null &amp;&amp; ttf.getCmap() != null &amp;&amp;</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">ttf.getCmap().getCmaps() != null &amp;&amp;</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">ttf.getCmap().getCmaps().length &gt; 0){</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">digits = new int[10];</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">CmapSubtable[] tables = ttf.getCmap().getCmaps();</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">CmapSubtable table = tables[0];// No matter what</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">for(int i =0;i&lt;10;i++){</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">digits[i] = table.getGlyphId(i+48)-1;</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">}</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">}</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">} catch (IOException e) {</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">digits = null;</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">}</span></div><div><span style="font-size: 1rem; background-color: rgb(245, 245, 245); color: rgb(51, 51, 51); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;, Inconsolata, monospace; line-height: 1.3125;">return digits;</span></div></div></div><div style="box-sizing: inherit; margin: 0px 0px 1.75em;"><br/></div><div style="box-sizing: inherit;"><span style="font-size: 16px; background-color: rgb(255, 255, 255); color: rgb(26, 26, 26); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; line-height: 1.75;"><img height="25" style="box-sizing:inherit;border:0px;height:auto;max-width:100%;vertical-align:middle;display:block;" width="840"></img><img height="25" style="box-sizing:inherit;border:0px;height:auto;max-width:100%;vertical-align:middle;display:block;" width="840"></img></span></div></div></div></div></div></div></div></div></div><div><br/></div></span>
</div></body></html>