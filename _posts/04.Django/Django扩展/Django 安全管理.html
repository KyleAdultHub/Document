---
title: Django-安全管理
date: "2016-10-07 22:00:00"
categories:
- Django
- Django拓展
tags:
- Django
toc: true
---

<html>
<body>
<div>
<span><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">Django 安全管理</span></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">CSRF跨站请求伪造</span></font></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">http的验证机制</span></font></li><ul><li><span style="font-size: 9pt;">HTTP服务器的验证方式</span></li><ul><li><span style="font-size: 9pt;">在HTTP中，允许Web浏览器或者其他客户端在发起请求时，以用户名和口令形式的进行登录验证，在验证成功后，将验证成功的信息存储在session或者cookie中，用来保持登录状态，这样便可以不用每次刷新页面都需要重新验证</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">优点</span></li><ul><li><span style="font-size: 9pt;">基于用户名和密码认证，简单，基本上所有网页浏览器都支持它。</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">请求成功后，利用cookie或者session将账户和密码保存在我们的浏览器中，可以达到快速访问的效果</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">缺点</span></li><ul><li><span style="font-size: 9pt;">常见的http连接，他们传输数据是明文方式，密码容易被拦截，所以在使用的时候一般要使用https安全连接</span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">CSRF简介</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">CSRF是什么</span></font></li><ul><li><span style="font-size: 9pt;">详细解释</span></li><ul><li><span style="font-size: 9pt;">跨站请求伪造，攻击者可以盗用你的身份，以你的名义发送恶意请求。当你登录网站成功后，如果你的浏览器中打开了恶意跨站请求伪造的网站，他就可以模仿你使用你的cookie和session来进行各种操作（因为你的浏览器已经记录了你登录成功的cookie或者session）</span><span style="font-size: 9pt; line-height: 1.45;">；</span></li></ul><li><span style="font-size: 9pt;">CSRF能够做的事情包括：</span></li><ul><li><span style="font-size: 9pt;">以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账......造成</span><span style="font-size: 9pt; line-height: 1.45;">的问题包括：个人隐私泄露以及财产安全</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">其他常见面的安全漏洞</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image.png" type="image/png" data-filename="Image.png" width="413"/></span></li><li><span style="font-size: 9pt;">XSS和CSRF官方介绍</span></li><ul><li><span style="font-size: 9pt;">A3—跨站脚本（XSS）</span></li><ul><li><span style="font-size: 9pt;">当应用程序收到含有不可信的数据，在没有进行适当的验证和转义的情况下，就将它发送给一个网页浏览器，这</span><span style="font-size: 9pt; line-height: 1.45;">就会产生跨站脚本攻击（简称XSS）。XSS允许攻击者在受害者的浏览器上执行脚本，从而劫持用户会话、危害网站</span><span style="font-size: 9pt; line-height: 1.45;">、或者将用户转向至恶意网站。</span></li><li><span style="font-size: 9pt;">常见场景：js脚本</span></li></ul><li><span style="font-size: 9pt;">A8—跨站请求伪造（CSRF）</span></li><ul><li><span style="font-size: 9pt;">一个跨站请求伪造攻击迫使用户已登录的浏览器将伪造的HTTP请求 （包括该用户的会话cookie和其他认证信息</span><span style="font-size: 9pt; line-height: 1.45;">）发送到一个存在漏洞的web应用程序。这就允许了攻击者迫使用户浏览器向存在漏洞的应用程序发送请求，而这些</span><span style="font-size: 9pt; line-height: 1.45;">请求会被应用程序认为是用户的合法请求。</span></li></ul></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">CSRF攻击的原理</span></font></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">总结：当我们在访问一个有很多重要操作的网站，如果我们只是用cookie或者session这种方式来记录登录信息等，当其他的恶意网站被我们打开的时候，他就可以在我们的浏览器终端中，利用我们的cookie和session在我们操作的重要网站上进行各种操作</span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [1].png" type="image/png" data-filename="Image.png" width="463"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">解决CSRF攻击的方法</span></font></li><ul><li><span style="font-size: 9pt;">使用POST方法进行请求和提交</span></li><ul><li><span style="font-size: 9pt;">POST方法不会将请求内容以明文的方式进行显示</span></li><li><span style="font-size: 9pt;">Django框架当使用POST方法进行请求的时候，csrf中间件会对post的请求进行csrf验证</span></li></ul><li><span style="font-size: 9pt;">开启代码框架内部的csrf防护功能</span></li><ul><li><span style="font-size: 9pt;">在setting文件中开启csrf中间件，这样每次在请求时，服务器端都会生成csrf键值对（这个键值对用来对用户端每次请求进行验证），每次在浏览器对服务器访问的时候，服务器会对客户端进行更加严格的验证；</span></li></ul><li><span style="font-size: 9pt;">在请求报文中包含csrf的键值对</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">表单提交的方式的请求中</span><span style="font-size: 9pt; line-height: 1.45;">在form表单中使用标签</span><span style="font-size: 9pt; line-height: 1.45;">{% csrf_token %}</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">在客户端会以一个type 为hidden形式的隐藏域存在，其name 和value会记录scrf生成的键值对，在下次请求的时候，会携带该信息，服务器端会进行csrf验证，这样就避免的csrf伪造攻击</span></font></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">通过ajax方式请求需要携带</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">'csrfmiddlewaretoken'</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">:</span><span style="font-size: 9pt;"> </span><span style="font-size: 9pt; line-height: 13.600000381469727px;">csrf_token</span><span style="font-size: 9pt;"> </span><span style="font-size: 9pt; line-height: 13.600000381469727px;">  ；</span></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">在客户端的ajax请求数据中，浏览器构造的数据会直接包含csrf的json数据，服务器端接收到数据后会进行csrf验证，如果 验证成功，就会允许ajax进行请求</span></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">注意：数据中的csrf_toke，要先在浏览器前台进行获取，即</span><span style="line-height: 13.600000381469727px; font-size: 9pt;">csrf_token = { { csrf_token } }</span></li></ul></ul></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">解决CSRF攻击的原理</span></font></li><ul><li><span style="font-size: 9pt;">当启用中间件并加入标签csrf_token后，在向客户端返回带有模板文件的响应报文的时候，django中间件CsrfViewMiddleware代码会向客户端浏览器中</span><span style="font-size: 9pt; line-height: 1.45;">写入一条Cookie信息csrftoken</span><span style="font-size: 9pt; line-height: 1.45;">这条信息的值与隐藏标签中的value属性是一致的；伪造网站可以使用我们的浏览器向我们想要请求的网站提交请求，但是不能携带表单当中的csrf_token的键值对内容</span></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">当向服务器提交数据的时候，先由csrf中</span><span style="font-size: 9pt; line-height: 1.45;">间件进行验证，对比hidden表单提交的value与cookie存储的内容是否一致，如果对比失败则返回403页面，而不会进行后续的处理</span></font></li></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><font style="font-size: 14pt;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold; line-height: 13.600000381469727px;-evernote-highlight:true;">验证码机制</span></font></span></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">验证码的作用</span></font></li><ul><li><span style="font-size: 9pt;">在用户注册、登录页面，为了防止暴力请求，可以加入验证码功能，如果验证码错误，则不需要继续处理，可以减轻</span><span style="font-size: 9pt; line-height: 1.45;">业务服务器、数据库服务器的压力</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">验证码生成和设置的步骤</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">安装pillow作图模块</span></font></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">安装模块</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [2].png" type="image/png" data-filename="Image.png" width="215"/></span></li></ul><li><span style="font-size: 9pt;">模块中常用的对象</span></li><ul><li><span style="font-size: 9pt;">Image 画布对象</span></li><li><span style="font-size: 9pt;">ImageDraw 画笔对象</span></li><li><span style="font-size: 9pt;">ImageFont 字体对象</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">定义生成验证码view函数</span></font></li><ul><li><span style="font-size: 9pt;">将生成的验证码存储到session中用来后续验证，生成验证码图片返回</span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [3].png" type="image/png" data-filename="Image.png" width="421"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [4].png" type="image/png" data-filename="Image.png" width="428"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">配置生成验证码和获取验证码图片的url</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [5].png" type="image/png" data-filename="Image.png" width="436"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">创建调用验证码并提交验证码的模板</span></font></li><ul><li><span style="font-size: 9pt;">创建验证码输入框，调用验证码图片，提交按钮对输入的验证码进行提交</span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [6].png" type="image/png" data-filename="Image.png" width="304"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [7].png" type="image/png" data-filename="Image.png" width="303"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">创建调用验证码页面的view函数</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [8].png" type="image/png" data-filename="Image.png" width="299"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">创建调用 验证码的url</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [9].png" type="image/png" data-filename="Image.png" width="397"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">创建对验证码进行对比验证的view函数</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [10].png" type="image/png" data-filename="Image.png" width="371"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">创建对验证码进行验证的URl</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [11].png" type="image/png" data-filename="Image.png" width="464"/></span></li></ul></ul></ul><div><font style="background-color: rgb(255, 250, 165); font-size: 14pt;-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">HTML转义</span></font></div></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">什么是HTML转义</span></font></li><ul><li><span style="font-size: 9pt;">在模板文件中以下的五个符号都在标签语言中有特殊的含义： </span><span style="font-size: 9pt; line-height: 1.45;">&lt;  &gt;  '   &quot;   &amp;      </span><span style="font-size: 9pt; line-height: 1.45;">但是在某些情况(模板对上下文传递的字符串进行输出时)下，他们会被转义成本来的字符串内容</span><span style="font-size: 9pt; line-height: 1.45;">转义前后的对照表如下，<span style="font-size: 9pt; line-height: 1.45;">所以说，</span></span><span style="font-size: 9pt; line-height: 1.45;">将有意义的html符号转换成原本的字符串内容，就是HTML转义。</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [12].png" type="image/png" data-filename="Image.png" width="249"/></span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">HTML转义的影响</span></font></li><ul><li><span style="font-size: 9pt;">HTML转义的影响</span></li><ul><li><span style="font-size: 9pt;">当view函数传输一个带特殊字符的字符串给模板的时候（比如使用标记语言的时候），在浏览器中显示出来的是原文的形式</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">原因：</span></li><ul><li><span style="font-size: 9pt;">标记语言中的大于和小于号被转义了，转成原来的字符意义了</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例：</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">view函数，将标记语言的字符串传递给模板</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [13].png" type="image/png" data-filename="Image.png" width="344"/></span></li></ul><li><span style="font-size: 9pt;">模板中变量标签接收view函数传递过来的参数</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [14].png" type="image/png" data-filename="Image.png" width="342"/></span></li></ul><li><span style="font-size: 9pt;">显示的结果为</span></li><ul><li><span style="font-size: 9pt;">浏览器页面</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [15].png" type="image/png" data-filename="Image.png" width="161"/></span></li></ul><li><span style="font-size: 9pt;">查看转义后的源码</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django 安全管理_files/Image [16].png" type="image/png" data-filename="Image.png" width="201"/></span></li></ul></ul></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 1.45;">Django将特殊符号转义的原因</span></li><ul><li><span style="font-size: 9pt; line-height: 1.45;">在客户端如果传入js代码，或者标签语言，公司的网站如果将其以参数传递给了模板文件，公司的网页可能就会被损坏，或者逻辑被修改，为了防止人为在客户端通过嵌入js代码攻击公司的网站，引入HTML特殊符号的转义</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">取消HTML转义的方法</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">取消HTML转义的场景</span></font></li><ul><li><span style="font-size: 9pt;">由视图给模板传递模板标签内容场景</span><span style="font-size: 9pt; line-height: 1.45;">父模板使用的上下文传递内容，如果传输的内容携带html的标签，某些标签默认是转义的</span><span style="font-size: 9pt; line-height: 1.45;">如果传递的时候，不想让这几个符号转义，那么在传递的时候，可以取消模板变量标签的html转义</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">设置变量标签的html转义----过滤器 escape</span></font></li><ul><li><span style="font-size: 9pt;">{{t1|escape}}</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">因为模板会默认对所有的变量标签进行html转义，所有一般用不到该过滤器</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">禁止变量标签转义----safe</span></font></li><ul><li><span style="font-size: 9pt;">{{data|safe}}</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">禁用转义，告诉模板这个变量是安全的，可以解释执行</span></font></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">对一段内容取消转义</span></font></li><ul><li><span style="font-size: 9pt;">{%autoescape off%}</span></li><li><span style="font-size: 9pt;">...</span></li><li><span style="font-size: 9pt;">{%endautoescape%}</span></li><ul><li><span style="font-size: 9pt;">我们需要对哪段代码取消转义，就应该在哪段代码两侧加上我们的autoescape标签</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">字符串取消转义</span></font></li><ul><li><span style="font-size: 9pt;">{{data|default:'&lt;b&gt;hello&lt;/b&gt;'}}</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">当不对变量传递参数的时候，默认值是不会转义的</span></li><li><span style="font-size: 9pt;">|default表示给前面的变量传递一个默认的内容</span></li><li><span style="font-size: 9pt;">要传递的内容使用单or双引号扩住</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">手工转义</span></font></li><ul><li><span style="font-size: 9pt;">{{data|default:&quot;&amp;lt;b&amp;gt;123&amp;lt;/b&amp;gt;&quot;}}</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">手动转义默认字符串，就是要将默认值更改为转义后的结果，这样在浏览器显示的结果和转义了的标签一样</span></li></ul></ul></ul></ul><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></div><div><br/></div></span>
</div></body></html>