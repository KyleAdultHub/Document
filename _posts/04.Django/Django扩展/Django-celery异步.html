---
title: Django-celery异步
date: "2016-11-09 22:00:00"
categories:
- Django
- Django拓展
tags:
- Django
toc: true
---


<html>
<body>
<div>
<span><div><font style="background-color: rgb(255, 250, 165); font-size: 14pt;-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">celery的简介</span></font></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">celery介绍</span></font></li><ul><li><font style="font-size: 9pt;"><span style="letter-spacing: 0.2px; orphans: 3; widows: 3;"><span style="font-size: 9pt; line-height: 1.45;">用户发起request，并等待response返回。在本些views中，可能需要执行一段耗时的程序，那么用户就会等待很长时间，造成不好的用户体验，比如发送邮件、手机验证码等。</span></span><span style="font-size: 9pt; line-height: 1.45;">使用celery后，情况就不一样了，将耗时的程序放到celery中执行。主程序继续执行其他功能。</span></font></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">celery和django的关系</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Django-celery异步_files/Image.png" type="image/png" data-filename="Image.png" width="447"/></span></li><li><font style="font-size: 9pt;">任务task：就是一个Python函数，定义需要交给celery处理的任务。</font></li><li><font style="font-size: 9pt;">队列queue：需要worker执行的任务会先加到queue中。</font></li><li><font style="font-size: 9pt;">工人worker：在一个新进程中，负责从queue中取出任务执行。</font></li><li><font style="font-size: 9pt;">代理人broker：负责调度，在布置环境中使用redis，用来存储queue列队。</font></li></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><font style="font-size: 14pt;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold; line-height: 13.600000381469727px;-evernote-highlight:true;">配置celery</span></font></span></div></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">安装celery相关的包</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Django-celery异步_files/Image [1].png" type="image/png" data-filename="Image.png" width="166"/></span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">在setting中安装celery应用</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Django-celery异步_files/Image [2].png" type="image/png" data-filename="Image.png" width="147"/></span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">在setting中配置任务和代理模块</span></font></li><ul><li><span style="font-size: 9pt;">import djcelery</span></li><li><img src="/e_img//e_img/Django-celery异步_files/Image [3].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="279"/></li><ul><li>配置celery环境</li><li>配置中间人的url路径</li><li>配置任务查找路径</li></ul></ul></ul><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold; line-height: 15.199999809265137px;-evernote-highlight:true;">使用selery代理任务</span></span></div><ul><li><span style="font-size: 10pt; font-weight: bold;">在应用的目录下创建tasks.py的文件，并创建应用的celery任务</span></li><ul><li><img src="/e_img//e_img/Django-celery异步_files/Image [4].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="763"/></li><ul><li><span style="font-size: 9pt;">@task： 对函数进行装饰，声明该函数是通过celery  worker来执行的函数</span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">在视图函数中调用celery任务</span></font></li><ul><li><img src="/e_img//e_img/Django-celery异步_files/Image [5].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="442"/></li><ul><li><span style="font-size: 9pt; line-height: 15.199999809265137px;">调用celery任务要在函数名后面加.delay，表示通过celery异步执行任务；</span></li><li><span style="font-size: 9pt; line-height: 15.199999809265137px;">因为task函数是在woker中执行的，我们在函数内生成的一些变量，在worker中可能因为没有我们使用的方法和函数，不能获取到，所以我们使用的变量等，都通过参数传递给task任务；</span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; line-height: 15.199999809265137px; font-weight: bold;">开启服务器</span></font></li><ul><li><span style="line-height: 15.199999809265137px; font-size: 9pt;">python manage.py runserver</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">开启redis服务</span></font></li><ul><li><span style="font-size: 9pt;">sudo service redis start</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">启动celery-worker</span></font></li><ul><li><span style="font-size: 9pt;">python manage.py celery worker -l info</span></li><ul><li><span style="font-size: 9pt;">-l info 表示打开日志</span></li></ul></ul></ul></div><div><br/></div></span>
</div></body></html>