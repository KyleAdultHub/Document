---
title: Django-Model
date: "2016-10-01 22:00:00"
categories:
- Django
- Django五大模块
tags:
- Django
toc: true
---

<html>
<head>
  <title>Django-全文检索</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/307941 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="765"/>
<h1>Django-全文检索</h1>

<div>
<span><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">全文检索的介绍</span></font></div><div><ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">全文检索</span></font></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 15.2px;">全文检索的概念</span></div></li><ul><li><div><span style="font-size: 9pt;">全文检索是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。</span></div></li><li><div><span style="font-size: 9pt;">这个过程类似于通过字典中的检索字表查字的过程。全文检索的方法主要分为按字检索和按词检索两种。按字检索是指对于文章中的每一个字都建立索引，检索时将词分解为字的组合。</span></div></li><li><div><span style="font-size: 9pt;">对于各种不同的语言而言，字有不同的含义，比如英文中字与词实际上是合一的，而中文中字与词有很大分别。英文等西方文字由于按照空白切分词，因此实现上与按字处理类似。中文等东方文字则需要切分字词，以达到按词索引的目的，当前全文检索技术难点是中文全文检索技术。</span></div></li><ul><li><div><span style="font-size: 9pt;">注意:</span></div></li><ul><li><div><span style="font-size: 9pt;">全文检索技术和数据库模糊查询是不同的。模糊查询最差情况下可能会进行全表扫描，如果数据量比较大，那么效率很低。</span></div></li></ul></ul></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">全文检索的一般过程</span></font></div></li><ul><li><div><span style="font-size: 9pt;">全⽂文检索⼤大体分两个过程，索引创建(Indexing)和搜索索引(Search)。</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">分词处理：将需要检录索引的内容，进行分词处理，提取一些特定语义的词语</span></div></li><li><div><span style="font-size: 9pt;">索引创建：将分词器分词的结果进行数据提取，创建索引的过程。</span></div></li><li><div><span style="font-size: 9pt;">搜索索引：就是得到⽤用户的查询请求，搜索创建的索引，然后返回结果的过程。</span></div></li></ul></ul><li><div><font style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">应用到的工具</span></font></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">分词器：将数据按照一定的规则进行分词处理，交给所有引擎进行索引的创建</span></div></li><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">搜索引擎：对分词器递交的关键字进行索引的创建，在搜索关键字信息的时候根据索引搜索关键字</span></font></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">框架：更简单的操作分词器和搜索引擎；</span></div></li></ul></ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">django的全文检索</span></font></div></li><ul><li><div><span style="font-size: 9pt;">haystack：全文检索的框架，支持whoosh、solr、Xapian、Elasticsearc四种全文检索引擎；</span></div></li><li><div><span style="font-size: 9pt;">whoosh：纯Python编写的全文搜索引擎，虽然性能比不上sphinx、xapian、Elasticsearc等，但是无二进制包，程序不会莫名其妙的崩溃，对于小型的站点，whoosh已经足够使用；</span></div></li><li><div><span style="font-size: 9pt;">jieba：一款免费的中文分词包，如果觉得不好用可以使用一些收费产品。</span></div></li></ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">haystasck的原理</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image.png" type="image/png" data-filename="Image.png" width="411"/></span><span style="font-size: 9pt; line-height: 1.45;">’</span></div></li></ul></ul><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">全文检索相关配置</span></font></div></div><div><ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">配置环境</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">安装需要的软件包</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [1].png" type="image/png" data-filename="Image.png" width="176"/></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">框架、搜索引擎、分词器</span></div></li></ul></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">安装haystack框架应用</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [2].png" type="image/png" data-filename="Image.png" width="134"/></span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">在setting中配置搜索引擎</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [3].png" type="image/png" data-filename="Image.png" width="405"/></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">指定索引文件的创建位置后，要在对应的位置创建索引目录</span></div></li></ul></ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">在上一步指定的目录下创建索引文件目录</span></div></li><ul><li><div><img src="Django-全文检索_files/Image [4].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="133"/></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">在项目同名目录下配置全文检索应用的url</span></font></div></li><ul><li><div><img src="Django-全文检索_files/Image [5].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="305"/></div></li></ul></ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">配置索引</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">在想要创建索引的模型类对应的应用目录下创建search_indexes.py文件</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [6].png" type="image/png" data-filename="Image.png" width="374"/></span></div></li><li><div><span style="line-height: 13.6px; font-size: 9pt;">text 字段的两个约束</span></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">document:  true表示会把查询数据放在text文本里面</span></div></li><li><div><span style="line-height: 13.6px; font-size: 9pt;">use_template: True  表示在模板中会指定查询的索引内容</span></div></li></ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">get_model函数:</span></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">表示会根据哪个模型类进行索引的建立和查询</span></div></li></ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">index_queryset函数：</span></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">表示根据模型类的哪些对象来进行创建索引和进行查询</span></div></li></ul></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">在templates目录下创建&quot;search/indexes/应用名/&quot;目录,并创建创建索引的  模型类名_text,txt</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [7].png" type="image/png" data-filename="Image.png" width="230"/></span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">在目录中创建已经创建文件，指定根据模型类的哪些字段建立索引，例如&quot;goodsinfo_text.txt&quot;文件；</span></font></div></li><ul><li><div><img src="Django-全文检索_files/Image [8].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="189"/></div></li></ul></ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">分词器相关配置</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">配置haystaic的默认分词器（</span><span style="font-size: 9pt; font-weight: bold;">找到虚拟环境目录下的haystack/backends/目录</span><span style="font-size: 9pt; font-weight: bold;">） </span></font></div></li><ul><li><div><span style="font-size: 9pt;">复制whoosh_backend.py文件，改为如下名称</span></div></li><ul><li><div><span style="font-size: 9pt;">whoosh_cn_backend.py</span></div></li></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">在文件内修改两处</span></div></li><ul><li><div><span style="font-size: 9pt;">引入中文分词器类</span></div></li><ul><li><div><span style="font-size: 9pt;">from jieba.analyse import ChineseAnalyzer</span></div></li></ul><li><div><span style="font-size: 9pt;">更改词语分析类:</span></div></li><ul><li><div><span style="font-size: 9pt;">查找</span></div><div><span style="font-size: 9pt;">analyzer=StemmingAnalyzer()</span></div><div><span style="font-size: 9pt;">改为</span></div><div><span style="font-size: 9pt;">analyzer=ChineseAnalyzer()</span></div></li></ul></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">备注：</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">因为我们使用了jieba中文分词器，所以要将原haystack框架默认使用的分词器替换成我们的中文分词器</span></div></li></ul></ul></ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">建立索引</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">初始化索引</span></font></div></li><ul><li><div><span style="font-size: 9pt;">python manage.py rebuild_index</span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">索引生成后目录结构如下图：</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [9].png" type="image/png" data-filename="Image.png" width="245"/></span></div></li></ul></ul></ul><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">使用全文检索</span></font></div></div><div><ul><li><div><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 21.6px;">创建输入框</span></font></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">配置应用的view函数</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [10].png" type="image/png" data-filename="Image.png"/></span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">配置应用url</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [11].png" type="image/png" data-filename="Image.png"/></span></div></li></ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">在templates的应用目录下创建query.html文件</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [12].png" type="image/png" data-filename="Image.png" width="312"/></span></div></li><li><div><span style="line-height: 1.45; font-size: 9pt;">我们要表单提交给，haystack视图接收的表单数据：</span></div></li><ul><li><div><span style="line-height: 1.45; font-size: 9pt;">q ：       表示搜索关键字，传递到模板中的数据为query</span></div></li><li><div><span style="line-height: 13.6px; font-size: 9pt;">page:    表示请求第几页的page对象</span></div></li><li><div><span style="line-height: 1.45; font-size: 9pt;">url：      请求haystack应用的url为/search/?q=' '&amp;page= n</span></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">表示请求q关键字，返回第n页的页面对象，不写page表示请求第一页</span></div></li></ul><li><div><span style="line-height: 1.45; font-size: 9pt;">form表单的 action属l必须写search，在前面已经配置好了</span></div></li></ul></ul></ul><li><div><span style="font-size: 10pt; font-weight: bold;">haystack视图渲染模板（将数据进行处理渲染到模板）</span></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">自定义搜索结果模板：在templates/search/目录下创建search.html</span></font></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [13].png" type="image/png" data-filename="Image.png" width="419"/></span></div></li><li><div><span style="line-height: 1.45; font-size: 9pt;">搜索结果进行分页，视图向模板中传递的上下文如下：</span></div></li><ul><li><div><span style="line-height: 1.45; font-size: 9pt;">query：搜索关键字</span></div></li><li><div><span style="line-height: 1.45; font-size: 9pt;">page：当前页的page对象</span></div></li><li><div><span style="line-height: 1.45; font-size: 9pt;">paginator：分页paginator对象</span></div></li></ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">注意：</span></div></li><ul><li><div><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">在search.html的模板中获取模型类实例对象</span></font></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">遍历page对象   ： 获取page对象的每一个singgle</span></div></li><li><div><span style="line-height: 13.6px; font-size: 9pt;">singgle.object ： 获取</span><span style="line-height: 13.6px; font-size: 9pt;">实例对象</span></div></li></ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">配置每页显示的对象数量</span></div></li><ul><li><div><span style="line-height: 13.6px; font-size: 9pt;">配置haystack包下的setting文件</span></div></li><ul><li><div><span style="font-size: 9pt;"><img src="Django-全文检索_files/Image [14].png" type="image/png" data-filename="Image.png"/></span></div></li></ul></ul></ul></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">结果</span></div></div><div><ul><li><div><img src="Django-全文检索_files/Image [15].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="246"/></div></li></ul></div><div><br/></div></span>
</div></body></html> 