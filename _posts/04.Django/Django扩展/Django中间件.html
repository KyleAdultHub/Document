---
title: Django中间件
date: "2016-10-12 22:00:00"
categories:
- Django
- Django拓展
tags:
- Django
toc: true
---

<html>
<body>
<div>
<span><div><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Django中间件</span></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">中间件的介绍</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">什么是Django的中间件</span></font></li><ul><li><span style="font-size: 9pt;">Django中的中间件是一个轻量级、底层的 插件系统，它可以介入Django的请求和响应处理过程，修改Django的输</span><span style="font-size: 9pt; line-height: 1.45;">入或输出。</span><span style="font-size: 9pt;">中间件的设计为开发者提供了一种无侵入式的开发方式，增强了Django框架的健壮性，其它的MVC框架也有这个功</span><span style="font-size: 9pt; line-height: 1.45;">能，名称为IoC。</span><span style="font-size: 9pt; line-height: 1.45;">IoC: inversion-of-control 反转控制</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">Django中间件的实质</span></font></li><ul><li><span style="font-size: 9pt;">django项目中的中间件（middleware），它们其实就是一个类，在请求到来和结束后，django会根据自己的规</span><span style="font-size: 9pt; line-height: 1.45;">则在合适的时机执行中间件中相应的方法。</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">Django中间件的作用</span></font></li><ul><li><span style="font-size: 9pt;">介入Django的请求和响应处理过程：</span><span style="font-size: 9pt; line-height: 1.45;">就是说Django接到请求之后，url的匹配过程、view的处理过程、models的调用过程、模板的渲染过程等，只要</span><span style="font-size: 9pt; line-height: 1.45;">是在django内部做的所有操作，虽然那些过程的代码都已经写死了，但是中间件是都能插上一脚，干预一下，避免修改</span><span style="font-size: 9pt; line-height: 1.45;">django源代码，来达到调试的效果。</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">中间件存在的意义</span></font></li><ul><li><span style="font-size: 9pt;">干预Django的流程处理过程中的某些环节</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">中间件使用的场景</span></font></li><ul><li><span style="font-size: 9pt;">view视图中如果出现非常频繁执行的内容，那么就放置到中间件中，大大的省事；比如：</span><span style="font-size: 9pt; line-height: 1.45;">每次发送post请求都要进行CSRF验证，所以就把CSRF验证的代码写在中间件中</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">中间件的思想</span></font></li><ul><li><span style="font-size: 9pt;">面向切面编程，是一种框架设计思想</span><span style="font-size: 9pt; line-height: 1.45;">切面的意思就是：把一个项目切割成几个层，然后可以分别观察处理等操作</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">Django中间件的setting配置</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django中间件_files/Image.png" type="image/png" data-filename="Image.png" width="507"/></span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">中间件与Django访问流程的关系</span></font></li><ul><li><span style="font-size: 9pt;">数字箭头代表各种中间件干预的位置，穿插在各个Django的处理流程中间</span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django中间件_files/Image [1].png" type="image/png" data-filename="Image.png" width="429"/></span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">中间件六方法</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">1.__init__()</span></font></li><ul><li><span style="font-size: 9pt;">初始化：无需任何参数，服务器响应同一用户的第一个请求的时候调用一次，用于确定是否启用当前中间件</span><span style="font-size: 9pt; line-height: 1.45;">，以后只要是同一用户的请求，就不在调用了</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">2.process_request(request)</span></font></li><ul><li><span style="font-size: 9pt;">处理请求前：在每个请求上调用，返回None或HttpResponse对象</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">3.process_view(</span><span style="font-size: 9pt; font-weight: bold;">request, view_func, view_args, view_kwargs</span><span style="font-size: 9pt; font-weight: bold;">)</span></font></li><ul><li><span style="font-size: 9pt;">处理视图前：在每个请求上调用，返回None或HttpResponse对象</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">4.process_template_response(request, response)   <span style="font-size: 9pt; font-weight: bold; color: rgb(255, 70, 53);"> ----不能显示结果结果</span></span></font></li><ul><li><span style="font-size: 9pt;">处理模板响应前：在每个请求上调用，返回实现了render方法的响应对象</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">5.process_response(request, response)</span></font></li><ul><li><span style="font-size: 9pt;">处理响应后：所有响应返回浏览器之前被调用，在每个请求上调用，返回HttpResponse对象</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">6.process_exception(request,exception)</span></font></li><ul><li><font style="font-size: 9pt;">异常处理：当视图抛出异常时调用（raise异常的时候也会被调用），在每个请求上调用，返回一个HttpResponse对象，<span style="line-height: 1.45;">只有发生状态码为5XX之类的错误才叫异常</span></font></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">中间件的简单操作</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/Django中间件_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django中间件_files/Image [3].png" type="image/png" data-filename="Image.png" width="440"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/Django中间件_files/Image [4].png" type="image/png" data-filename="Image.png" width="444"/></span></li></ul></ul><div><font style="font-size: 18px;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 18px; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold; line-height: 18.399999618530273px;-evernote-highlight:true;">中间件的执行流程</span></span></font></div></div><div><ul><li><span style="font-weight: bold; line-height: 18.399999618530273px;">中间件干预的过程</span></li><ul><li><span style="font-size: 9pt; line-height: 18.399999618530273px;">注册了的中间件，中间件函数会对其影响的django中间过程进行干预，对request和Response进行处理或者返回给客户端</span></li></ul><li><span style="line-height: 18.399999618530273px;"><b>中间件执行的顺序</b></span></li><ul><li><span style="line-height: 18.399999618530273px;"><b><font style="font-size: 9pt;">对请求进行处理的中间件（<span style="font-size: 9pt; font-weight: bold;">process_request、process_view</span>）</font></b></span></li><ul><li><font style="font-size: 12px;"><span style="line-height: 18.399999618530273px;">在处理请求之前进行调用，当多个中间件定义了<span style="line-height: 18.399999618530273px; font-size: 9pt;">process_request、process_view方法，先注册的中间件，会先执行</span></span></font></li></ul><li><span style="line-height: 18.399999618530273px; font-weight: bold; font-size: 9pt;">对响应进行处理的中间件（<span style="font-size: 9pt; font-weight: bold;">process_response</span></span><span style="line-height: 18.399999618530273px; font-weight: bold; font-size: 9pt;">）</span></li><ul><li><font style="font-size: 9pt;"><span style="line-height: 18.399999618530273px;">当视图处理之前进行调用，当多个中间件定义了<span style="line-height: 18.399999618530273px;">process_response方法，对Response进行返回的时候，先注册的中空间件会后执行，后注册的中间件会先执行</span></span></font></li></ul><li><font style="font-size: 12px;"><span style="line-height: 18.399999618530273px;"><b>对异常进行处理的中间件（<span style="font-size: 9pt; line-height: 18.399999618530273px;">process_exception</span>）</b></span></font></li><ul><li><font style="font-size: 9pt;">当view视图产生异常的时候调用， 当多个中间件中定义了process_exception方法的时候，那么先注册的中间件其方法后执行,后注册的中间件其方法先执行</font></li></ul></ul><li><span style="line-height: 13.600000381469727px;"><b>中间件对响应的返回</b></span></li><ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">Django的处理响应过程，第基于短路处理的，当某个中间件在处理的时候返回了HttpResponse给客户端，那么响应过程终止，之后的中间件和view函数处理等将不会再进行；</font></span></li><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">最终的响应是由process_response中间件来返回的，所以不管是中间件返回响应，还是view函数返回了响应，会直接经过process_response中间件方法，再将响应返回给客户端浏览器；</font></span></li><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">如果在view视图中产生异常，最终响应便不是由<span style="line-height: 13.600000381469727px;">process_response中间件来进行处理的，是由precess_exception方法来进行处理响应并返回；</span></font></span></li></ul><li><font style="font-size: 10pt;"><span style="line-height: 13.600000381469727px;"><b>中间件处理响应和返回响应的示意图</b></span></font></li><ul><li><img src="/e_img/Django中间件_files/Image [5].png" type="image/png" data-filename="Image.png" style="font-weight: bold;" width="265"/></li></ul></ul><div><br/></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); line-height: 13.600000381469727px; font-weight: bold; color: rgb(50, 135, 18); font-size: 14pt;-evernote-highlight:true;">记录浏览器上一次访问的页面的中间件</span></span></div></div><div><ul><li><img src="/e_img/Django中间件_files/Image [6].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="532"/></li></ul></div><div><br/></div></span>
</div></body></html>