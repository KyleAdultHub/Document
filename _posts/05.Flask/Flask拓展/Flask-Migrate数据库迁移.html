---
title: Flask-Migrate数据库迁移
date: "2017-08-04 22:00:00"
categories:
- Flask
- Flask拓展
tags:
- Flask
toc: true
---

<html>
<body>
<div>
<span><div><div><span style="font-size: 18.399999618530273px; background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="color: rgb(50, 135, 18); background-color: rgb(255, 250, 165); font-size: 18.399999618530273px; line-height: 21.600000381469727px; font-weight: bold;-evernote-highlight:true;">数据库迁移扩展Flask-Migrate</span></span></div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; line-height: 13.600000381469727px; font-weight: bold;">什么是数据库的迁移</span></font></li><ul><li><span style="font-size: 9pt;">在开发过程中，需要修改数据库模型，而且还要在修改之后更新数据库。最直接的方式就是删除旧表，但这样会丢失数据。</span></li><li><span style="font-size: 9pt; line-height: 1.45;">更好的解决办法是使用数据库迁移框架，它可以追踪数据库模式的变化，然后把变动应用到数据库中。</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; line-height: 13.600000381469727px; font-weight: bold;">Flask-Migrate拓展</span></font></li><ul><li><span style="font-size: 9pt;">在Flask中可以使用Flask-Migrate扩展，来实现数据迁移。并且集成到Flask-Script中，所有操作通过命令就能完成。</span></li><li><span style="font-size: 9pt;">为了导出数据库迁移命令，Flask-Migrate提供了一个MigrateCommand类，可以附加到flask-script的manager对象上。</span></li></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); line-height: 1.45; font-weight: bold; color: rgb(50, 135, 18); font-size: 14pt;-evernote-highlight:true;">使用Flask-migrate的步骤</span></span></div><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px; font-weight: bold;">前提</span></font></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">已经通过Alchemy拓展创建了数据库表的类</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45; font-weight: bold;">安装拓展</span></font></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">pip install flask-migrate</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px; font-weight: bold;">通过Flask-Script注册迁移命令</span></font></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">from flask import Flask</span></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">from flask_script import import Manager</span></font></li><li><span style="font-size: 9pt;">from flask_sqlalchemy import SQLAlchemy</span></li><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">from flask_migrate import Migrate, MigrateCommand</span></li><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">app = Flask(__name__)</span></li><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">db = SQLAlchemy(app)</span></li><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">manager = Manager(app)</span></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">Migrate(app, db, 'migrate_dir')            关联迁移，将app和数据库的操作对象传入</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">migrate_dir 为迁移文件存储的文件夹，默认为migrates</span></font></li></ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">manager.add_comment('db', MigrateCommand)          注册迁移命令到Flask-Script</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">第一个参数是，在命令行中通过它来使用迁移相关命令</span></font></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">初始化迁移，创建迁移仓库(</span><span style="font-size: 9pt; font-weight: bold; line-height: 1.45;">创建migrations文件夹，所有迁移文件都放在里面</span><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">)</span></font></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">初始化迁移命令</span></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">python  database.py  db  init </span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px; font-weight: bold;">生成迁移文件（每次对数据库模型类的修改都需要重新迁移）</span></font></li><ul><li><span style="line-height: 13.600000381469727px; font-size: 9pt;">生成迁移文件命令</span></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">python  database.py  db  migrate  -m  'initial migration'</span></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">-m : 表示对迁移版本的 </span></li></ul></ul><li><span style="line-height: 1.45; font-size: 9pt;">生成迁移的结果：</span></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">自动创建一个迁移脚本包含两个函数，</span><span style="line-height: 1.45; font-size: 9pt;">根据模型定义和数据库当前状态的差异，<span style="line-height: 1.45; font-size: 9pt;">生成upgrade()和downgrade()函数</span></span></li><li><span style="line-height: 1.45; font-size: 9pt;">两个函数操作内容不一定完全正确，有可能会遗漏一些细节，需要进行检查，自行进行改动</span></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">upgrade()：函数把迁移中的数据库的改动同步到数据库中</span></font></li><li><span style="line-height: 1.45; font-size: 9pt;">downgrade()：函数将upgrade()的改动回滚删除</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px; font-weight: bold;">更新数据库表</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">python  database.py  db  upgrade</span></font></li></ul><li><font style="font-size: 9pt;"><span style="line-height: 13.600000381469727px; font-size: 9pt; font-weight: bold;">查看历史迁移记录</span></font></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">python app.py db history</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px; font-weight: bold;">回滚到指定版本</span></font></li><ul><li><span style="line-height: 1.45; font-size: 9pt;">python app.py db downgrade 指定版本号</span></li></ul></ul><div><font size="2"><span style="line-height: 13.600000381469727px;"><br/></span></font></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); line-height: 13.600000381469727px; font-weight: bold; color: rgb(50, 135, 18); font-size: 14pt;-evernote-highlight:true;">实际使用的操作顺序-总结</span></span></div><ul><li><span style="font-size: 9pt; line-height: 1.45;">1.python 文件 db init</span></li><li><span style="font-size: 9pt; line-height: 1.45;">2.python 文件 db migrate -m&quot;版本名(注释)&quot;</span></li><li><span style="font-size: 9pt; line-height: 1.45;">3.python 文件 db upgrade 然后观察表结构</span></li><li><span style="font-size: 9pt; line-height: 1.45;">4.根据需求修改模型</span></li><li><span style="font-size: 9pt; line-height: 1.45;">5.python 文件 db migrate -m&quot;新版本名(注释)&quot;</span></li><li><span style="font-size: 9pt; line-height: 1.45;">6.python 文件 db upgrade 然后观察表结构</span></li><li><span style="font-size: 9pt; line-height: 1.45;">7.若返回版本,则利用 python 文件 db history查看版本号</span></li><li><span style="font-size: 9pt; line-height: 1.45;">8.python 文件 db downgrade(upgrade) 版本号</span></li></ul><div><br/></div></div><div><br/></div></span>
</div></body></html>