---
title: Flask-SQLAlchemy数据库交互
date: "2017-08-06 22:00:00"
categories:
- Flask
- Flask拓展
tags:
- Flask
toc: true
---

<html>
<body>
<div>
<span><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Flaks-SQLALchemy扩展</span></font></div><div><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">在Flask中使用数据库要用到Flask-SQLALchemy扩展，Flask-SQLALchemy应用了SQLALchemy框架</span></li><li><span style="font-size: 9pt;">SQLAlchemy是一个关系型数据库框架，它提供了高层的ORM和底层的原生数据库的操作。</span></li><li><span style="font-size: 9pt;">SQLALchemy 实际上是对数据库的抽象，让开发者不用直接和 SQL 语句打交道，而是通过 Python 对象来操作数据库，在舍弃一些性能开销的同时，换来的是开发效率的较大提升</span></li></ul><div><font style="font-size: 14pt;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Django与Flask操作数据库的对比</span></font></div></div><div><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image.png" type="image/png" data-filename="Image.png" width="437"/> </span></li></ul><div><font style="font-size: 14pt;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold; line-height: 21.600000381469727px;-evernote-highlight:true;">使用SQLAlchemy操作数据库</span></span></font></div></div><div><ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">安装flask-sqlalchemy扩展</span></font></li><ul><li><span style="font-size: 9pt;">pip install flask-sqlalchemy       安装sqlalchemy数据库拓展</span></li></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">配置SQLALchemy</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">导入SQLAlchemy</span></font></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">from flask import flask</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">from flask_sqlalchemy import SQLAlchemy</span></li></ul><li><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">配置数</span><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">据库连接的URI并初始化SQLAlchemy</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">配置数据库的连接方式</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">app = Flask(__name__)</span></li><li><span style="font-size: 9pt;">app.config[&quot;SQLALCHEMY_DATABASE_URI&quot;] =&quot;mysql://root:mysql@127.0.0.1:3306/py3&quot;</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">配置是否追踪数据库的修改操作，即数据库有修改就会提示</span></li><ul><li><span style="font-size: 9pt;">app.config[&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;] = False</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">初始化SQLAlchemy</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db = SQLAlchemy(app)</span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">SQLAlchemy其他的配置</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [1].png" type="image/png" data-filename="Image.png" width="459"/></span></li></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">创建模型类（对应数据库的表）</span></li><ul><li><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">创建模型类应用到的方法和参数</span></li><ul><li><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">一对多模型</span></li><ul><li><span style="font-size: 9pt;">__tablename__: 创建表的表名（不写默认为类型小写）</span></li><li><span style="font-size: 9pt;">db.Column: 代表创建表的字段</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">第一个参数为数据类型，其他的为该字段的约束条件</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.ForeignKey() 代表设置外键字段</span></li></ul><li><span style="font-size: 9pt;">db.relationship  （前提是设置了外键）设置表的关系属性，在一对多关系中常设置在一的一端，可以通过一端查询多端数据</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">backref： 反向引用，可以通过关联表的另一端的实例，查询到该表的数据</span></font></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">lazy:   默认为subquery</span></li><ul><li><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">设置为subquery</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">，则会在设置关系字段的一端加载完对象后，就立即加载与其关联的对象，这样会让总查询数量减少，但如果返回的条目数量很多，就会比较慢</span></li><ul><li><span style="font-size: 9pt;">设置为 subquery 的话，author.books 返回所有数据列表</span></li></ul><li><span style="font-size: 9pt; line-height: 1.45;"><span style="font-size: 9pt; line-height: 1.45; font-weight: bold;">设置为动态方式dynamic</span>，这样关联对象会在被使用的时候再进行加载，并且在返回前进行过滤，如果返回的对象数很多，或者未来会变得很多，那最好采用这种方式</span></li><li><span style="font-size: 9pt;">设置为 dynamic 的话，role.users 返回模型实例对象</span></li></ul></ul><li><span style="font-size: 9pt;">__repr__方法： 代表打印实例的时候，显示的内容</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">代码示例：</span></li><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [2].png" type="image/png" data-filename="Image.png" style="font-weight: bold;" width="428"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">多对多模型</span></font></li><ul><li><span style="font-size: 9pt;">代码示例</span></li><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [3].png" type="image/png" data-filename="Image.png" style="line-height: 1.45;" width="382"/></span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">常用的SQLALchemy字段类型</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [4].png" type="image/png" data-filename="Image.png" width="426"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">常用的SQLALchemy列选项</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [5].png" type="image/png" data-filename="Image.png" width="427"/></span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">常用的SQLALchemy关系选项</span></font></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [6].png" type="image/png" data-filename="Image.png" width="433"/></span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">数据库表的操作</span></font></li><ul><li><span style="font-size: 9pt;">在数据库中创建对应模型类的表</span></li><ul><li><span style="font-size: 9pt;">db.creat_all()</span></li></ul><li><span style="font-size: 9pt;">清空数据库中的所有表</span></li><ul><li><span style="font-size: 9pt;">db.drop_all()</span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold;">数据库增、删、改、查</span><span style="font-size: 10pt; font-weight: bold; line-height: 1.45;">操作</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">数据库操作原理</span></font></li><ul><li><span style="font-size: 9pt;">在Flask-SQLAlchemy中，插入、修改、删除操作，均由数据库会话管理。</span></li><li><span style="font-size: 9pt;">会话用db.session表示。在准备把数据写入数据库前，要先将数据添加到会话中然后调用 commit() 方法提交会话。</span></li><li><span style="font-size: 9pt;">在Flask-SQLAlchemy中，查询操作是通过query对象操作数据。</span></li><li><span style="font-size: 9pt;">最基本的查询是返回表中所有数据，可以通过过滤器进行更精确的数据库查询。</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">数据库会话操作</span></font></li><ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">对操作进行提交，默认是不会进行提交的</font></span></li><ul><li><font style="font-size: 9pt;"><span style="line-height: 13.600000381469727px;">db.session.commit()   </span></font></li></ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">对数据库操作进行回滚操作</font></span></li><ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">db.session.rollback()</font></span></li></ul><li><font style="font-size: 9pt;"><span style="line-height: 13.600000381469727px;">对数据进行删除</span></font></li><ul><li><font style="font-size: 9pt;"><span style="line-height: 13.600000381469727px;">db.session.delete()</span></font></li></ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">取消和数据库的连接</font></span></li><ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">db.session.remove()</font></span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">数据库的增删改查</span></font></li><ul><li><span style="font-size: 9pt;">添加数据（创建数据实例，向表中添加）</span></li><ul><li><span style="font-size: 9pt;">单条添加</span></li><ul><li><span style="font-size: 9pt;">rol = Role(name='admin')</span></li><li><span style="font-size: 9pt;">db.session.add(ro1)</span></li><li><span style="font-size: 9pt;">db.session.commit()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">批量添加数据</span></li><ul><li><span style="font-size: 9pt;">rol = Role(name='admin')</span></li><li><span style="font-size: 9pt;">rol = Role(name='admin')</span></li><li><span style="font-size: 9pt;">db.session.add_all([ rol1, rol2 ])</span></li><li><span style="font-size: 9pt;">db.session.commit()</span></li></ul></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">删除数据（获取到数据实例，再进行删除）</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.session.delete(rol1)</span></font></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">修改数据（获取到数据实例，在进行修改）</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">rol.name = '改变后的值'</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">查询数据</span></li><ul><li><span style="font-size: 9pt;">查询所用方法</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [7].png" type="image/png" data-filename="Image.png" width="394"/></span></li><li><font style="font-size: 12px;"><span style="font-size: 12px; line-height: 13.600000381469727px;">limit（）返回范围内的查询结果</span></font></li></ul><li><span style="font-size: 9pt;">查询所用过滤器</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img//e_img/Flask-SQLAlchemy数据库交互_files/Image [8].png" type="image/png" data-filename="Image.png" width="375"/></span></li></ul><li><span style="font-size: 9pt;">filter_by精确查询</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter_by(id=4).first()</span></font></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">filter模糊查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(User.name.endswith('g').all()</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(User.name.startswith('a')).all()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">filter条件查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">等查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(User.id==4).first()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">非查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">from sqlalchemy import not_</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(not_(User.name=='wang')).all()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">与查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">from sqlanchemy import and_</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(and_(User.name.startswith('li'), User.email.startswith('li'))).all()</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">可以直接不使用and_进行与查询，默认写多个条件就是与的关系</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">或查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">from sqlanchemy import or_</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(or_(User.password=='123', User.email.endswith('li'))).all()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">范围查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.filter(User.id.in_([1, 2, 3, 4])).all()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">排序查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">User.query.order_by(User.email.desc()).all()</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">分页查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">paginate = User.query.paginate(2, 3, False)</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">参数分别：查询第几页，每页几条数据，是否有错误输出</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">paginate.page 当前页</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">paginate.pages  所有页数</span></li><li><span style="line-height: 13.600000381469727px;">paginate.items   当前分页当中过得所有模型对象</span></li></ul><li><br/></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">关联查询</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">在一端查询多段数据</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">rol1. users.all()</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">users为在模型类中设置的关系字段</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">通过一端的记录对象来查询多端的所用关联对象（前提是设置了关系字段）</span></li></ul></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">在多端查询一端的数据</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">user.role.first()</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">role为关系字段的backref属性的内容</span></li></ul></ul></ul></ul></ul></ul></ul></ul></div><div><br/></div></span>
</div></body></html>