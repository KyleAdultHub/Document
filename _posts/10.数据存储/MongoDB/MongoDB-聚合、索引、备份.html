---
title: MongoDB-聚合、索引、备份
date: "2016-07-04 22:00:00"
categories:
- 数据存储
- MongoDB
tags:
- MongoDB
toc: true
---

<html>
<body>
<div>
<span><div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold; line-height: 13.600000381469727px;-evernote-highlight:true;">聚合操作</span></span></span></div><ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">聚合操作介绍</span></li><ul><li><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">聚合(aggregate)</span></span></li><ul><li><span style="font-size: 9pt;">基于数据处理和聚合管道，由多个阶段的管道（stage）组成</span></li><li><span style="font-size: 9pt;">每个阶段的管道具有分组、过滤等功能</span></li><li><span style="font-size: 9pt; line-height: 1.45;">处理文档的时候，每个管道会对其进行以一些的分组，过滤等，最终输出结果 </span></li></ul><li><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">聚合工作视图</span></span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image.png" type="image/png" data-filename="Image.png" width="421"/></span></li></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">管道的使用</span></li><ul><li><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">管道的表达式</span></span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">表达式</span></li><ul><li><span style="font-size: 9pt; line-height: 1.45;">db.集合名称.aggregate({管道名:{表达式}})</span></li></ul></ul><li><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">常用管道</span></span></li><ul><li><span style="font-size: 9pt; line-height: 1.45;">$group： 将集合中的⽂档分组， 可⽤于统计结果</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$match： 过滤数据， 只输出符合条件的⽂档</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$project： 修改输⼊⽂档的结构， 如重命名、 增加、 删除字段、 创建计算结果</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$sort： 将输⼊⽂档排序后输出</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$limit： 限制聚合管道返回的⽂档数</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$skip： 跳过指定数量的⽂档， 并返回余下的⽂档</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$unwind： 将数组类型的字段进⾏拆分</span></li></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 1.45;">常⽤表达式（只能配合$group管道使用）:</span></span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">语法：</span><span style="font-size: 9pt; line-height: 1.45;">表达式:  '$列名'</span></font></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">$sum：   计算总和，     $sum:1 表示以⼀倍计数</span></font></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">$avg：    计算平均值</span></font></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">$min：    获取最⼩值</span></font></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;">$max：   获取最⼤值</span></font></li><li><span style="font-size: 9pt; line-height: 1.45;">$first：   根据资源⽂档的排序获取第⼀个⽂档数据</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$last：    根据资源⽂档的排序获取最后⼀个⽂档数据</span></li><li><span style="font-size: 9pt; line-height: 1.45;">$push：  将结果⽂档中插⼊值到⼀个数组中</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">$push  表达式的效果</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [1].png" type="image/png" data-filename="Image.png" style="line-height: 1.45;" width="182"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [2].png" type="image/png" data-filename="Image.png" width="479"/></span></li></ul><li><span style="font-size: 9pt;">$push: '$$ROOT'  的效果</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [3].png" type="image/png" data-filename="Image.png" style="line-height: 1.45;" width="208"/></span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [4].png" type="image/png" data-filename="Image.png" width="492"/></span></li></ul></ul><li><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.600000381469727px;">聚合管道使用方法</span></span></li><ul><li><span style="font-size: 9pt; line-height: 1.45;">$match   过滤</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例：</span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [5].png" type="image/png" data-filename="Image.png" width="267"/></span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">$group   分组</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例：</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [6].png" type="image/png" data-filename="Image.png" width="209"/></span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">_id ：用来确定分组字段，</span><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">表示靠哪个字段进行分组，后面接 $字段名（</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">null为统计全部</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">）</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">（_id固定，不能改名称）</span></font></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">当依据多个字段进行分组的时候要将，多个字段以{显示字段:1 $分组字段1， 显示字段2, $分组字段2}</span></li><ul><li><span style="font-size: 9pt;">示例：<img src="/e_img/MongoDB-聚合、索引、备份_files/Image [7].png" type="image/png" data-filename="Image.png" width="370"/></span></li></ul><li><span style="font-size: 9pt;">如果字段的值为字典，并且想以值的一个字段来分组 表达式写成  $文档字段.字段值的字段</span></li><ul><li><span style="font-size: 9pt;">示例：<img src="/e_img/MongoDB-聚合、索引、备份_files/Image [8].png" type="image/png" data-filename="Image.png" width="406"/></span></li></ul></ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">下面的显示字段： 表达式计算的结果显示字段（可随意更改名称）</span></font></li></ul></ul><li><span style="font-size: 9pt; line-height: 1.45;">$project     修改输入文档结构，按照$project 定义的格式进行输出</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例：</span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [9].png" type="image/png" data-filename="Image.png" width="297"/></span></li><li><span style="font-size: 9pt;">重命名字段：   $project:{新字段名：&quot;$原字段名&quot;}</span></li><li><span style="font-size: 9pt;">将字段显示或者去除：  字段值为1表示显示，字段值为0表示隐藏</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">_id 字段默认的值为1，如果想隐藏，需要将其值改为0</span></li></ul><li><span style="font-size: 9pt; line-height: 1.45;">$sort     将文档进行排序</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例：</span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [10].png" type="image/png" data-filename="Image.png" width="268"/></span></li><li><span style="font-size: 9pt;">字段值为-1表示按照字段降序排序，1为表示按照字段升序排序</span></li></ul><li><span style="font-size: 9pt; line-height: 1.45;">$limit与</span><span style="font-size: 9pt; line-height: 1.45;">$skip    获取固定数量与跳过指定数量的文档</span></li><ul><li><span style="font-size: 9pt;">示例：</span></li><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [11].png" type="image/png" data-filename="Image.png" width="301"/></span></li><li><span style="box-sizing: border-box;"><span style="font-size: 9pt; line-height: 1.45;">$limit     只获取指定数量的文档</span></span></li><li><span style="box-sizing: border-box;"><span style="font-size: 9pt; line-height: 1.45;">$skip    跳过指定数量文档</span></span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">注意：在使用的时候，要先写skip , 后写limit</span></li></ul><li><span style="font-size: 9pt; line-height: 1.45;">$unwind       将包含数组数值的文档，拆分成多条</span></li><ul><li><span style="font-size: 9pt; line-height: 1.45;">语法：</span></li><ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">普通写法：</font></span></li><ul><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">db.collection_name.aggregate({$unwind:'$字段名称'})    </font></span></li><ul><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">$unwind 后边接$字段名称就可以,不需要接字典类型的数据</font></span></li><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">这种情况，当数组中没有内容的时候，将不会被$unwind输出，会造成数据丢失</font></span></li></ul></ul><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">防止数据丢失写法</font></span></li><ul><li><font style="font-size: 9pt;"><span style="line-height: 1.45;">db.collection_name.aggregate({$unwind:{ path: '</span><span style="line-height: 1.45;">'$字段名称'</span><span style="line-height: 1.45;">', preserveNullAndEmptyArrays:true  }})</span></font></li><ul><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">如果数组的内容为空的数据，将会被$unwind去掉对应的字段    </font></span></li><li><span style="line-height: 13.600000381469727px;"><font style="font-size: 9pt;">preserve  的值默认为false不会进行数据防丢失</font></span></li></ul></ul></ul><li><font style="font-size: 9pt;"><span style="line-height: 13.600000381469727px;">示例1：</span></font></li><ul><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">db.t2.insert({_id:1,item:'t-shirt',size:['S','M','L']})</font></span></li><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">db.t2.aggregate({$unwind:'$size'})</font></span></li><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">结果如下：</font></span></li><li><span style="line-height: 1.45;"><font style="font-size: 9pt;">{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;t-shirt&quot;, &quot;size&quot; : &quot;S&quot; }</font></span></li><li><span style="font-size: 9pt; line-height: 1.45;">{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;t-shirt&quot;, &quot;size&quot; : &quot;M&quot; }</span></li><li><span style="font-size: 9pt; line-height: 1.45;">{ &quot;_id&quot; : 1, &quot;item&quot; : &quot;t-shirt&quot;, &quot;size&quot; : &quot;L&quot; }</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">示例2：</span></li><ul><li><span style="font-size: 9pt;"><img src="/e_img/MongoDB-聚合、索引、备份_files/Image [12].png" type="image/png" data-filename="Image.png" width="385"/></span></li></ul></ul></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">创建索引</span></span></div><ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">创建普通索引的方法</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.collection_name.ensureindex({&quot;字段名&quot;：1})</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">1表示升序， 会提升升序sort操作的效率</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">-1表示降序，会提升降序sort操作的效率</span></li></ul></ul><li><font style="font-size: 10pt;"><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">创建唯一索引的方法</span></font></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.t1.ensureindex(</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">{&quot;字段名&quot;：1，{&quot;unique&quot;: true，&quot;dropDups&quot;: true}}</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">)</span></font></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">&quot;unique&quot;: true 表示创建的索引是唯一索引，默认值为false</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">&quot;dropDups&quot;: true  表示消除重复，会删除，索引字段值重复的文档，默认值为false</span></li><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">创建唯一索引后，不能向集合中添加重复的数据</span></li></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">创建联合索引</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.t1.ensureindex({&quot;字段1&quot;:1, &quot;字段2&quot;:1})</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">当需要联合查询才能确定到确定文档的时候，可以建立联合索引</span></li></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">查看当前集合的所有索引</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.t1.getindexes()</span></li></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">删除索引</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">db.t1.dropindex(&quot;索引字段名称&quot;)</span></li></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">创建索引后的影响</span></li><ul><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">提升了数据库的查询</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">find\sort</span><span style="font-size: 9pt; line-height: 13.600000381469727px;">速度（要根据创建索引的字段进行查询 ）</span></font></li><li><font style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.600000381469727px;">当创建唯一索引后，便不能向集合中添加相同的索引字段的数据</span></font></li></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">备注：</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">显示执行mongodb语句的时间：在表达式的后边加上.explain('executionStats')</span></li></ul></ul><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">数据库的备份和恢复（在终端中操作）</span></span></span></span></div><ul><li><span style="font-size: 10pt; font-weight: bold;">备份数据库的语法</span></li><ul><li><span style="font-size: 9pt;">mongodump -h dbhost -d dbname -o dbdirectory</span></li><ul><li><span style="font-size: 9pt;">-h：  服务器地址， 也可以指定端⼝号（默认表示本机的默认ip地址和端口号）</span></li><li><span style="font-size: 9pt;">-d： 需要备份的数据库目录名称</span></li><li><span style="font-size: 9pt;">-o： 备份的数据存放位置， 此⽬录中存放着备份出来的数据</span></li></ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">备注</span></li><ul><li><span style="font-size: 9pt; line-height: 13.600000381469727px;">备份后都是.json和.bson的文件</span></li></ul></ul><li><span style="font-size: 10pt; font-weight: bold; line-height: 13.600000381469727px;">数据库恢复的语法：</span></li><ul><li><span style="font-size: 9pt;">mongorestore -h dbhost -d dbname --dir dbdirectory</span></li><ul><li><span style="font-size: 9pt;">-h： 服务器地址加端口号（默认为本机默认端口）</span></li><li><span style="font-size: 9pt;">-d： 需要恢复的数据库实例名称</span></li><li><span style="font-size: 9pt;">--dir： 备份数据所在位置</span></li></ul></ul></ul><div><br/></div></div><div><br/></div></span>
</div></body></html>