---
title: Scrapy对接BloomFilter
date: "2017-04-21 23:00:00"
categories:
- python爬虫
- scrapy框架
tags:
- 爬虫
- scrapy
toc: true
typora-root-url: ..\..\..
---

<html>
<body>
<div>
<span><div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b><font style="color: rgb(50, 135, 18); font-size: 14pt;">Scrapy对接BloomFilter</font></b></span></div><ul><li><div><b><font style="font-size: 12pt;">通过修改源码的方式对接</font></b></div></li><ul><li><div><span style="font-size: 9pt;"><b>对接的原则</b></span></div></li><ul><li><div><span style="font-size: 9pt;">实现Bloom Filter时，首先要保证不能破坏Scrapy-Redis分布式爬取的运行架构。</span></div></li><li><div><span style="font-size: 9pt;">我们需要修改Scrapy-Redis的源码，将它的去重类替换掉。同时，Bloom Filter的实现需要借助于一个位数组，既然当前架构还是依赖于Redis，那么位数组的维护直接使用Redis就好了。</span></div></li><li><div><span style="font-size: 9pt;">首先实现一个基本的散列算法，将一个值经过散列运算后映射到一个m位数组的某一位上，代码如下：</span></div></li></ul><li><div><span style="font-size: 9pt;"><b>实现BloomFilter过滤器类</b></span></div></li><ul><li><div><span style="font-size: 9pt;"><img src="/e_img/Scrapy对接BloomFilter_files/Image.png" type="image/png" data-filename="Image.png" width="653"/></span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/Scrapy对接BloomFilter_files/Image [1].png" type="image/png" data-filename="Image.png" width="653"/></span></div></li></ul></ul><li><div><span style="font-size: 9pt;"><b>接下来继续修改Scrapy-Redis的源码</b></span></div></li><ul><li><div><span style="font-size: 9pt;">修改源码的位置</span></div></li><ul><li><div><span style="font-size: 9pt;">将scrapy-redis的dupefilter逻辑替换为Bloom Filter的逻辑。</span></div></li><li><div><span style="font-size: 9pt;">主要是修改RFPDupeFilter类的request_seen()方法</span></div></li><li><div><span style="font-size: 9pt;">利用request_fingerprint()方法获取Request的指纹，调用Bloom Filter的exists()方法判定该指纹是否存在。如果存在，则说明该Request是重复的，返回True，否则调用Bloom Filter的insert()方法将该指纹添加并返回False。这样就成功利用Bloom Filter替换了Scrapy-Redis的集合去重。</span></div></li></ul><li><div><span style="font-size: 9pt;">修改request_seen方法，修改判断元素是否重复的方法</span></div></li><ul><li><div><span style="font-size: 9pt;"><img src="/e_img/Scrapy对接BloomFilter_files/Image [2].png" type="image/png" data-filename="Image.png" width="603"/></span></div></li></ul><li><div><span style="font-size: 9pt;">修改__init__ 方法，将判断重复类修改为BloomFilter</span></div></li><ul><li><div><span style="font-size: 9pt;"><img src="/e_img/Scrapy对接BloomFilter_files/Image [3].png" type="image/png" data-filename="Image.png" width="605"/></span></div></li></ul><li><div><span style="font-size: 9pt;">相关参数，通过from_setting方法获取</span></div></li><ul><li><div><span style="font-size: 9pt;"><img src="/e_img/Scrapy对接BloomFilter_files/Image [4].png" type="image/png" data-filename="Image.png" width="604"/></span></div></li></ul><li><div><span style="font-size: 9pt;">修改setting文件</span></div></li><ul><li><div><span style="font-size: 9pt;">BLOOMFILTER_HASH_NUMBER = 6        配置布隆过滤器的哈希函数的数量</span></div></li><li><div><span style="font-size: 9pt;">BLOOMFILTER_BIT = 30           设置存储使用的位数</span></div></li></ul></ul><li><div><b><font style="font-size: 12pt;">直接使用scrapy-redis-bloomfilter框架</font></b></div></li><ul><li><div><span style="font-size: 9pt;"><b>下载scrapy-redis-bloomfilter</b></span></div></li><ul><li><div><span style="font-size: 9pt;">pip3 install scrapy-redis-bloomfilter</span></div></li></ul><li><div><span style="font-size: 9pt;"><b>修改setting.py文件</b></span></div></li><ul><li><div><span style="font-size: 9pt;">DUPEFILTER_CLASS = &quot;scrapy_redis_bloomfilter.dupefilter.RFPDupeFilter&quot;  # 去重类，要使用Bloom Filter请替换DUPEFILTER_CLASS</span></div></li><li><div><span style="font-size: 9pt;">BLOOMFILTER_HASH_NUMBER = 6   # 散列函数的个数，默认为6，可以自行修改</span></div></li><li><div><span style="font-size: 9pt;">BLOOMFILTER_BIT = 30     # Bloom Filter的bit位移参数(代表 1 &lt;&lt; 30 )，默认30，占用128MB空间，去重量级1亿</span></div></li></ul></ul></ul></div><div><br/></div></span>
</div></body></html>