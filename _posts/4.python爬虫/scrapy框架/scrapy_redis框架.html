---
title: Scrapy-redis框架
date: "2017-03-18 16:00:00"
categories:
- python爬虫
- scrapy框架
tags:
- 爬虫
- scrapy
toc: true
typora-root-url: ..\..\..
---

<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/307941 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="632"/>

<div>
<span><div><span style="font-size: 14pt;background-color: #fffaa5;-evernote-highlight:true;"><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">scrapy_redis的介绍</span></span></div><div><ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis的官方介绍</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">基于redis的scrapy组件</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">使用scrapy_redis要安装scrapy_redis组件（pip install scrapy_redis）</span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis使用场景</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 15.2px;">增量式抓取、分布式抓取、持久化抓取</span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis实现的功能及与原生scrapy的区别</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">request去重</span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">scrapy：可以实现去重，但是scrapy去重不能实现持久化，即当下次如果再次运行程序，会再次存储之前存储过得内容</span></span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">scrapy_redis：会将请求过的指纹集合保存起来，用来判断重复我请求，即便重新运行程序，已经请求过的请求，也不会进入待请求对列中</span></span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">爬虫持久化</span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">scrapy：每次运行爬虫都是一次全新的开始</span></span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">scrapy_redis：会将待请求的序列化后的request对象保存起来，这样每次运行程序都会从待请求列队中读取request对象进行请求，即使终止程序，再次运行，依然会从待请求对列中获取请求对象</span></span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">分布式爬虫</span></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">scrapy：不能实现分布式</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">scrapy_redis：可以通过redis存储爬取的状态（已爬取，和待爬取），让多台机器上的爬虫程序，共用一个redis服务器，这样数据是共享的，实现了分布式的爬虫</span></div></li></ul></ul><li><div><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">分布式和集群的区别（备注）：</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">分布式：一个业务拆分成多个子业务，部署在不同的服务器上</span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">集群，同一个业务，部署在多个服务器上</span></span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis的爬虫工作流程</span></div></li><ul><li><div><img src="/e_img/scrapy_redis框架_files/Image.png" type="image/png" data-filename="Image.png" style="font-size: 9pt; line-height: 1.45;" width="371"/></div></li></ul></ul></div><div><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Scrapy_redis和scrapy框架使用的区别</span></div><div><ul><li><div><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">克隆scrapy_redis的示例代码</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">克隆 github上的scrapy-redis源码文件</span></div></li><li><div><span style="font-size: 9pt; line-height: 1.45;">git clone</span> <a href="https://github.com/rolando/scrapy-redis.git" shape="rect" style="font-size: 9pt; line-height: 1.45;">https://github.com/rolando/scrapy-redis.git</a></div></li><li><div><span style="font-size: 9pt; line-height: 1.45;">打开example-project的scrapy_redis示例源代码</span></div></li><li><div><span style="font-size: 9pt; line-height: 1.45;">mv scrapy-redis/example-project    项目目录</span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">example-project项目目录结构如下</span></div></li><ul><li><div><img src="/e_img/scrapy_redis框架_files/Image [1].png" type="image/png" data-filename="Image.png" width="423"/></div></li></ul><li><div><span style="font-weight: bold;">redis_scrapy代码上和普通scrapy爬虫的区别</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">一、spider爬虫文件</span></span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">第一种Scrapy爬虫（如示例dmoz.py）</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">区别：</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">和普通的爬虫文件没有区别</span></span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">文件主要内容：</span></span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [2].png" type="image/png" data-filename="Image.png" width="385"/> </span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">第二种RedisSpider爬虫（如示例的myspider_redis.py）</span></span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">区别</span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">爬虫类继承自RedisSpider</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">要指定爬虫类的redis_key类属性，指定reids中存储start_url的位置</span></div></li><li><div><span style="font-size: 12px;">新增了爬虫类的方法</span></div></li><li><div><span style="font-size: 9pt;">def make_request_from_data(self, data):   # data 为接收到额redis_key传递过来的url，我们可以自行拼接成想要的url进行请求</span></div></li><ul><li><div><span style="font-size: 9pt;">search_key = data</span></div></li><li><div><span style="font-size: 9pt;">url = self.URL_MAIN % (search_key, 1)</span></div></li><li><div><span style="font-size: 9pt;">result_item = SearchInfoResultItem()</span></div></li><li><div><span style="font-size: 9pt;">result_item[&quot;task_value&quot;] = search_key</span></div></li><li><div><span style="font-size: 9pt;">return Request(url, meta={&quot;result_item&quot;: result_item}, dont_filter=True)</span></div></li></ul></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">作用</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">防止分布式爬虫在不同的程序中，都会去请求该start_url，这样会造成请求的重复，响应也会重复的交给解析函数去处理，从redis中取出的start_url第一次被爬虫取出之后便会删除掉，不会造成重复的请求</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">在持久化和去重的功能上实现了RedisSpider爬虫才实现了分布式</span></div></li></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">代码示例：</span></div></li><ul><li><div><img src="/e_img/scrapy_redis框架_files/Image [3].png" type="image/png" data-filename="Image.png" style="font-size: 9pt;" width="484"/></div></li></ul></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">第三种RedisCrawSpider爬虫（如示例的myspider_redis.py）</span></span></div></li><ul><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">区别</font></span></div></li><ul><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">爬虫类继承自RedisCrawlSpider</font></span></div></li><li><div><font style="font-size: 9pt;"><span style="line-height: 13.6px;">比</span><span style="line-height: 13.6px;">RedisSpider爬虫就多了一个rules过滤功能</span></font></div></li></ul><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">作用</font></span></div></li><ul><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">在持久化和去重的功能上实现了RedisSpider爬虫才实现了分布式</font></span></div></li><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">另外可以实现自动的对响应中的连接进行匹配，进行请求</font></span></div></li></ul><li><div><span style="line-height: 13.6px;"><font style="font-size: 9pt;">代码示例</font></span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [4].png" type="image/png" data-filename="Image.png" width="356"/></span></div></li></ul></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold;">二、setting文件</span></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">区别：</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">设置了三个新的属性</span></div></li><ul><li><div><span style="font-size: 9pt;">DUPEFILTER_CLASS = &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">指定爬虫给request对象去重的方法</span></div></li></ul><li><div><span style="font-size: 9pt;">SCHEDULER = &quot;scrapy_redis.scheduler.Scheduler&quot;</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">指定爬虫处理请求列队的方法</span></div></li></ul><li><div><span style="font-size: 9pt;">SCHEDULER_PERSIST = True</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">列队中的内容是否持久保存，为False的时候，在关闭程序的时候，清空redis</span></span></div></li></ul></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">添加了一个处理item的pipeline</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;"> 'scrapy_redis.pipelines.RedisPipeline': 400</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">用来将items自动保存到reids中，我们可以取消，不用reids来保存</span></div></li></ul></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">设置了redis的地址</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">REDIS_URL = 'redis://192.168.207.130: 6379'</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">不写使用哪个数据库的话，默认使用0数据库</span></span></div></li></ul></ul></ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">文件主要内容：</span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [5].png" type="image/png" data-filename="Image.png" width="471"/></span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">三、运行爬虫后，reids数据库的中多出的键（运行程序后）</span></span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">redis数据库多个三个键</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">爬虫名：dupefilter   用来存储爬取过的request指纹集合，数据类型为set类型</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">爬虫名：requests  用来存储已经序列化的待请求对象，数据类型为zset类型</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">爬虫名：items    用来存储爬取出来的数据，数据类型为list类型</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">每个键存储的内容：</span></span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [6].png" type="image/png" data-filename="Image.png" width="466"/></span></div></li></ul></ul></ul><div><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Scrapy_redis功能实现的方法(</span><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">Scrapy_redis的源码</span><span style="background-color: rgb(255, 250, 165); font-size: 14pt; color: rgb(50, 135, 18); font-weight: bold;-evernote-highlight:true;">)</span></div><div><ul><li><div><span style="font-size: 10pt; font-weight: bold; line-height: 13.6px;">scrapy_redis之redispipeline</span><span style="font-weight: bold; line-height: 13.6px;">（实现item数据自动存储redis数据库）</span></div></li><ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">文件位置</span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt;">/python3.5/site-packages/</span>scrapy_redis/pipelines/RedisPipeline</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">源码主要功能</span></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">实现将item存储在redis中</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">源码片段</span></span></div></li></ul></ul></div><ul><ul><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [7].png" type="image/png" data-filename="Image.png" width="461"/></span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis之RFPDupeFilter（主要实现去重）</span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 15.2px;">文件位置</span></div></li><ul><li><div><span style="font-size: 9pt;">/python3.5/site-packages/</span><span style="font-size: 9pt;">scrapy_redis、dupefilter/RFPDpeFilter</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">源码主要功能</span></span></div></li><ul><li><div><span style="line-height: 13.6px;">判断请求是否存在内存中，如果不存在</span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">对请求进行一系列操作后，将其转化为指纹</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">将指纹存储在内存中</span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">主要实现去重功能</span></span></span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">源码片段</span></span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [8].png" type="image/png" data-filename="Image.png" width="415"/></span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">加密指纹生成过程</span></span></div></li><ul><li><div><span style="font-size: 9pt;">  import hashlib</span></div></li><li><div><span style="font-size: 9pt;">  fp = hashlib.sha1()</span></div></li><li><div><span style="font-size: 9pt;">  fp.update(url)</span></div></li><li><div><span style="font-size: 9pt;">  fp.update(request.method)</span></div></li><li><div><span style="font-size: 9pt;">  fp.update(request.body or b&quot;&quot;)</span></div></li><li><div><span style="font-size: 9pt;">  return fp.hexdiget()  #sha1结果的16进制的字符串</span></div></li></ul><li><div><span style="font-size: 10pt; font-weight: bold;">scrapy_redis之Scheduler（主要实现持久化）</span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 15.2px;">文件位置</span></div></li><ul><li><div><span style="font-size: 9pt;">/python3.5/site-packages/</span><span style="font-size: 9pt;">scrapy_redis/scheduler/Scheduler</span></div></li></ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">代码主要功能</span></span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">判断取消过滤是否为true</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">判断url地址是否是第一次看到</span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">如果过滤，且是第一次看到的请求，那么将会进入待请求的列队</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">主要实现持久化功能</span></div></li></ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 13.6px;">源码片段</span></div></li><li><div><span style="font-size: 9pt;"><img src="/e_img/scrapy_redis框架_files/Image [9].png" type="image/png" data-filename="Image.png" width="446"/></span></div></li></ul></ul><div><span style="font-size: 14pt;"><span style="background-color: #fffaa5;-evernote-highlight:true;"><span style="font-size: 14pt; background-color: rgb(255, 250, 165); color: rgb(50, 135, 18); font-weight: bold; line-height: 15.2px;-evernote-highlight:true;">scrapy_redis的总结</span></span></span></div></div><div><ul><li><div><span style="font-size: 10pt; font-weight: bold; line-height: 1.45;">scrapy_redis与scrapy的区别</span></div></li><ul><li><div><span style="font-size: 9pt; font-weight: bold; line-height: 15.2px;">本质区别</span></div></li><ul><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 1.45;"><span style="font-size: 9pt; line-height: 1.45;">scrapy_redis_spider</span>相比于之前的scrapy_spider多了持久化和持久化去重的功能</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 1.45;">主要是因为scrapy_redis将指纹和请求进行了在redis中的存储,正是redis实现了持久化</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">代码区别</span></span></div></li><ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; line-height: 13.6px;">仅仅是在setting中增加了五行代码</span></span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">拓展：</span></span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">scrapy_redis实现了请求的增量式爬虫，还可以实现内容增量式爬虫</span></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">可以将dont_filter设置不进行过滤</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">会将每条数据根据发帖人，发帖时间，帖子更新时间等使用md5算法生成指纹</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">在进行存储的时候 进行判断是否已经存在，以及是否更新</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">如果不存在那么便插入</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">如果存在但是更新时间已经更新，那么便更新</span></div></li></ul><li><div><span style="font-size: 12px;"><span style="font-size: 12px; font-weight: bold; line-height: 13.6px;">工作场景常用的数据存储模式</span></span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">优点</span></div></li><ul><li><div><span style="font-size: 9pt; line-height: 13.6px;">可以利用redis的读取快速的特点，进行数据的快速读取</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">可以实现读取和存储分离，防止锁表的产生</span></div></li><li><div><span style="font-size: 9pt;"><span style="font-size: 9pt; line-height: 13.6px;">存储数据用mysql或者mongodb</span></span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">先将爬取到的数据去重后存储到mysql或mongodb中</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">也可以先存储到数据库中，在对数据库进行数据的去重</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">redis应用其速度快的特点，用来展示数据</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">定期从mysql或者mongodb中将去重后的数据读取到redis中</span></div></li><li><div><span style="font-size: 9pt; line-height: 13.6px;">读取数据从redis中读取，其速度远远优于mysql和mongodb</span></div></li></ul></ul></ul></div><div><br clear="none"/></div></span>
</div></body></html>